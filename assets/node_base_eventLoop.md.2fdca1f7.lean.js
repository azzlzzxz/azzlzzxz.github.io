import{_ as c,B as t,o as r,c as i,N as l,D as p,z as o,x as s,a as n}from"./chunks/framework.2673bc46.js";const A=JSON.parse('{"title":"Node çš„äº‹ä»¶å¾ªç¯æœºåˆ¶","description":"","frontmatter":{},"headers":[],"relativePath":"node/base/eventLoop.md","lastUpdated":1727602247000}'),d={name:"node/base/eventLoop.md"};function y(F,a,D,m,b,u){const e=t("font");return r(),i("div",null,[a[2]||(a[2]=l(`<h1 id="node-çš„äº‹ä»¶å¾ªç¯æœºåˆ¶" tabindex="-1">Node çš„äº‹ä»¶å¾ªç¯æœºåˆ¶ <a class="header-anchor" href="#node-çš„äº‹ä»¶å¾ªç¯æœºåˆ¶" aria-label="Permalink to &quot;Node çš„äº‹ä»¶å¾ªç¯æœºåˆ¶&quot;">â€‹</a></h1><p><img src="https://steinsgate.oss-cn-hangzhou.aliyuncs.com/Node_EventLoop.jpg" alt="node_eventLoop"></p><h2 id="event-loop-æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹" tabindex="-1"><code>event loop</code> æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ <a class="header-anchor" href="#event-loop-æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹" aria-label="Permalink to &quot;\`event loop\` æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹&quot;">â€‹</a></h2><p>å½“ <code>Node.js</code> å¯åŠ¨æ—¶ï¼Œå®ƒåˆå§‹åŒ–äº‹ä»¶å¾ªç¯ï¼Œå¤„ç†æä¾›çš„è¾“å…¥è„šæœ¬ï¼Œè¿™äº›è„šæœ¬å¯èƒ½è¿›è¡Œå¼‚æ­¥ <code>API</code> è°ƒç”¨ã€è°ƒåº¦è®¡æ—¶å™¨æˆ–è°ƒç”¨ <code>process.nextTick()</code>ï¼Œç„¶åå¼€å§‹å¤„ç†äº‹ä»¶å¾ªç¯ã€‚</p><div class="language-lua line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span style="color:#BABED8;">â”Œâ”€</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;">â”‚        timers         â”‚</span></span>
<span class="line"><span style="color:#BABED8;">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span style="color:#BABED8;">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span style="color:#BABED8;">â”‚  â”‚     pending callbacks â”‚</span></span>
<span class="line"><span style="color:#BABED8;">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span style="color:#BABED8;">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span style="color:#BABED8;">â”‚  â”‚     idle, prepare     â”‚</span></span>
<span class="line"><span style="color:#BABED8;">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span style="color:#BABED8;">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   </span><span style="color:#FFCB6B;">incoming</span><span style="color:#BABED8;">:   â”‚</span></span>
<span class="line"><span style="color:#BABED8;">â”‚  â”‚         poll          â”‚</span><span style="color:#89DDFF;">&lt;</span><span style="color:#BABED8;">â”€â”€â”€â”€â”€â”¤  connections, â”‚</span></span>
<span class="line"><span style="color:#BABED8;">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   data, etc.  â”‚</span></span>
<span class="line"><span style="color:#BABED8;">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span style="color:#BABED8;">â”‚  â”‚        check          â”‚</span></span>
<span class="line"><span style="color:#BABED8;">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span style="color:#BABED8;">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span style="color:#BABED8;">â””â”€â”€â”¤    close callbacks    â”‚</span></span>
<span class="line"><span style="color:#BABED8;">   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div>`,5)),p(e,{color:"#5887ff"},{default:o(()=>a[0]||(a[0]=[s("ul",null,[s("li",null,[s("code",null,"timers:"),n(" æ‰§è¡Œ "),s("code",null,"setTimeout"),n(" å’Œ "),s("code",null,"setInterval"),n(" ä¸­åˆ°æœŸçš„ "),s("code",null,"callback"),n("ã€‚")]),s("li",null,[s("code",null,"pending callback:"),n(" ä¸Šä¸€è½®å¾ªç¯ä¸­å°‘æ•°çš„ "),s("code",null,"callback"),n(" ä¼šæ”¾åœ¨è¿™ä¸€é˜¶æ®µæ‰§è¡Œã€‚")]),s("li",null,[s("code",null,"idle, prepare:"),n(" ä»…åœ¨å†…éƒ¨ä½¿ç”¨ã€‚")]),s("li",null,[s("code",null,"poll:"),n(" æœ€é‡è¦çš„é˜¶æ®µï¼Œæ‰§è¡Œ "),s("code",null,"pending"),n(),s("code",null,"callback"),n("ï¼Œåœ¨é€‚å½“çš„æƒ…å†µä¸‹ä¼šé˜»å¡åœ¨è¿™ä¸ªé˜¶æ®µã€‚")]),s("li",null,[s("code",null,"check:"),n(" æ‰§è¡Œ "),s("code",null,"setImmediate"),n(" çš„ "),s("code",null,"callback"),n("ã€‚")]),s("li",null,[s("code",null,"close callbacks:"),n(" æ‰§è¡Œ close äº‹ä»¶çš„ "),s("code",null,"callback"),n("ï¼Œä¾‹å¦‚ "),s("code",null,"socket.on(â€˜closeâ€™[,fn])"),n("æˆ–è€… "),s("code",null,"http.server.on('close, fn)"),n("ã€‚")])],-1)])),_:1}),a[3]||(a[3]=l(`<blockquote><p><code>setImmediate()</code>æ˜¯å°†äº‹ä»¶æ’å…¥åˆ°äº‹ä»¶é˜Ÿåˆ—å°¾éƒ¨ï¼Œä¸»çº¿ç¨‹å’Œäº‹ä»¶é˜Ÿåˆ—çš„å‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åç«‹å³æ‰§è¡Œ <code>setImmediate</code> æŒ‡å®šçš„å›è°ƒå‡½æ•°</p></blockquote><p><code>event loop</code> çš„æ¯ä¸€æ¬¡å¾ªç¯éƒ½éœ€è¦ä¾æ¬¡ç»è¿‡ä¸Šè¿°çš„é˜¶æ®µã€‚</p><p>æ¯ä¸ªé˜¶æ®µéƒ½æœ‰è‡ªå·±çš„ <code>FIFO</code> çš„ <code>callback</code> é˜Ÿåˆ—ï¼ˆåœ¨ <code>timer</code> é˜¶æ®µå…¶å®ä½¿ç”¨ä¸€ä¸ªæœ€å°å †è€Œä¸æ˜¯é˜Ÿåˆ—æ¥ä¿å­˜æ‰€æœ‰å…ƒç´ ï¼Œæ¯”å¦‚ <code>timeout</code> çš„ <code>callback</code> æ˜¯æŒ‰ç…§è¶…æ—¶æ—¶é—´çš„é¡ºåºæ¥è°ƒç”¨çš„ï¼Œå¹¶ä¸æ˜¯å…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—é€»è¾‘ï¼‰ï¼Œæ¯å½“è¿›å…¥æŸä¸ªé˜¶æ®µï¼Œéƒ½ä¼šä»æ‰€å±çš„é˜Ÿåˆ—ä¸­å–å‡º <code>callback</code> æ¥æ‰§è¡Œã€‚</p><p>å½“é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…è¢«æ‰§è¡Œ <code>callback</code> çš„æ•°é‡è¾¾åˆ°ç³»ç»Ÿçš„æœ€å¤§æ•°é‡æ—¶ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚è¿™å…­ä¸ªé˜¶æ®µéƒ½æ‰§è¡Œå®Œæ¯•ç§°ä¸ºä¸€è½®å¾ªç¯ã€‚</p><h2 id="timers" tabindex="-1"><code>timers</code> <a class="header-anchor" href="#timers" aria-label="Permalink to &quot;\`timers\`&quot;">â€‹</a></h2><blockquote><p>æºç åœ°å€ <a href="https://github.com/nodejs/node/blob/23a3410f9fecf2c8652eef4f92b4072edf307137/deps/uv/src/timer.c#L163" target="_blank" rel="noreferrer">uv__run_timers</a></p></blockquote><p>åœ¨ <code>timers</code> é˜¶æ®µï¼Œä¼šæ‰§è¡Œ <code>setTimeout</code> å’Œ <code>setInterval</code> ä¸­åˆ°æœŸçš„ <code>callback</code>ã€‚æ‰§è¡Œè¿™ä¸¤è€…å›è°ƒéœ€è¦è®¾ç½®ä¸€ä¸ªæ¯«ç§’æ•°ï¼Œç†è®ºä¸Šæ¥è¯´ï¼Œåº”è¯¥æ˜¯æ—¶é—´ä¸€åˆ°å°±ç«‹å³æ‰§è¡Œ <code>callback</code> å›è°ƒï¼Œä½†æ˜¯ç”±äº <code>system</code> çš„è°ƒåº¦å¯èƒ½ä¼šå»¶æ—¶ï¼Œè¾¾ä¸åˆ°é¢„æœŸæ—¶é—´ã€‚å¦‚ä¸‹ä¾‹ï¼š</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> fs </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">require</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">fs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">someAsyncOperation</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">callback</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFile</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/path/to/file</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">callback</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> timeoutScheduled </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> Date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#BABED8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">setTimeout</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">delay</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">Date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">timeoutScheduled</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">\`\${</span><span style="color:#BABED8;">delay</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">ms have passed since I was scheduled</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">100</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">someAsyncOperation</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">startCallback</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">Date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#F07178;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">Date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">startCallback</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">10</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// do nothing</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>å½“è¿›å…¥äº‹ä»¶å¾ªç¯æ—¶ï¼Œå®ƒæœ‰ä¸€ä¸ªç©ºé˜Ÿåˆ—ï¼ˆ<code>fs.readFile()</code>å°šæœªå®Œæˆï¼‰ï¼Œå› æ­¤å®šæ—¶å™¨å°†ç­‰å¾…å‰©ä½™æ¯«ç§’æ•°ï¼Œå½“åˆ°è¾¾ <code>95ms</code>ï¼ˆå‡è®¾ <code>fs.readFile()</code>éœ€è¦ <code>95ms</code>ï¼‰æ—¶ï¼Œ<code>fs.readFile()</code>å®Œæˆè¯»å–æ–‡ä»¶å¹¶ä¸”å…¶å®Œæˆéœ€è¦ <code>10ms</code> çš„å›è°ƒè¢«æ·»åŠ åˆ°è½®è¯¢é˜Ÿåˆ—å¹¶æ‰§è¡Œã€‚</p><p>å› æ­¤ï¼ŒåŸæœ¬è®¾ç½® <code>100ms</code> åæ‰§è¡Œçš„å›è°ƒå‡½æ•°ï¼Œä¼šåœ¨çº¦ <code>105ms</code> åæ‰§è¡Œã€‚</p><h2 id="pending-callbacks" tabindex="-1"><code>pending callbacks</code> <a class="header-anchor" href="#pending-callbacks" aria-label="Permalink to &quot;\`pending callbacks\`&quot;">â€‹</a></h2><p>æ­¤é˜¶æ®µæ‰§è¡ŒæŸäº›ç³»ç»Ÿæ“ä½œï¼ˆä¾‹å¦‚ <code>TCP</code> é”™è¯¯ç±»å‹ï¼‰çš„å›è°ƒã€‚</p><p>ä¾‹å¦‚ï¼šå¦‚æœ <code>TCP socket ECONNREFUSED</code> åœ¨å°è¯• <code>connect</code> æ—¶ <code>receives</code>ï¼Œ ç³»ç»Ÿå¸Œæœ›ç­‰å¾…æŠ¥å‘Šé”™è¯¯ï¼Œè¿™å°†åœ¨ <code>pending callbacks</code> é˜¶æ®µæ‰§è¡Œã€‚</p><h2 id="poll-è½®è¯¢" tabindex="-1"><code>poll</code>ï¼ˆè½®è¯¢ï¼‰ <a class="header-anchor" href="#poll-è½®è¯¢" aria-label="Permalink to &quot;\`poll\`ï¼ˆè½®è¯¢ï¼‰&quot;">â€‹</a></h2><p>æ‰§è¡Œ <code>pending callback</code>ï¼Œåœ¨é€‚å½“çš„æƒ…å†µä¸‹ä¼šé˜»å¡åœ¨è¿™ä¸ªé˜¶æ®µã€‚</p><p><code>poll</code> é‡Œé¢ æœ‰å¾ˆå¤šå›è°ƒ node ä¸­æœ‰æ‰§è¡Œçš„æœ€å¤§ä¸ªæ•°ï¼Œè¶…è¿‡æœ€å¤§ä¸ªæ•°ä¼šè¢«å»¶è¿Ÿåˆ°ä¸‹ä¸€è½®å¾ªç¯æ‰§è¡Œã€‚</p><p><code>poll</code> é˜¶æ®µæœ‰ä¸¤ä¸ªä¸»è¦åŠŸèƒ½ï¼š</p><ol><li>æ‰§è¡Œ <code>I/O</code>ï¼ˆè¿æ¥ã€æ•°æ®è¿›å…¥/è¾“å‡ºï¼‰å›è°ƒã€‚</li><li>å¤„ç†è½®è¯¢é˜Ÿåˆ—ä¸­çš„äº‹ä»¶ã€‚</li></ol><p>å½“äº‹ä»¶å¾ªç¯è¿›å…¥ <code>poll</code> é˜¶æ®µå¹¶ä¸”åœ¨ <code>timers</code> ä¸­æ²¡æœ‰å¯ä»¥æ‰§è¡Œå®šæ—¶å™¨æ—¶ï¼š</p><ul><li><p>å¦‚æœ <code>poll</code> é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™äº‹ä»¶å¾ªç¯å°†éå†å…¶åŒæ­¥æ‰§è¡Œå®ƒä»¬çš„ <code>callback</code> é˜Ÿåˆ—ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–è€…è¾¾åˆ° system-dependentï¼ˆç³»ç»Ÿç›¸å…³é™åˆ¶ï¼‰ã€‚</p></li><li><p>å¦‚æœ <code>poll</code> é˜Ÿåˆ—ä¸ºç©ºï¼Œä¼šæ£€æŸ¥æ˜¯å¦æœ‰ <code>setImmediate()</code>å›è°ƒéœ€è¦æ‰§è¡Œï¼Œå¦‚æœæœ‰åˆ™é©¬ä¸Šè¿›å…¥æ‰§è¡Œ <code>check</code> é˜¶æ®µä»¥æ‰§è¡Œå›è°ƒã€‚</p></li><li><p>å¦‚æœ <code>timers</code> ä¸­æœ‰å¯ä»¥æ‰§è¡Œå®šæ—¶å™¨ä¸” <code>poll</code> é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œåˆ™ä¼šåˆ¤æ–­æ˜¯å¦æœ‰ <code>timer</code> è¶…æ—¶ï¼Œå¦‚æœæœ‰çš„è¯ä¼šå›åˆ° <code>timer</code> é˜¶æ®µæ‰§è¡Œå›è°ƒã€‚</p></li></ul><h2 id="check" tabindex="-1"><code>check</code> <a class="header-anchor" href="#check" aria-label="Permalink to &quot;\`check\`&quot;">â€‹</a></h2><p>æ­¤é˜¶æ®µæ‰§è¡Œ <code>setImmediate</code> çš„ <code>callback</code>ã€‚</p><p><code>setImmediate()</code>å®é™…ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è®¡æ—¶å™¨ï¼Œå®ƒåœ¨äº‹ä»¶å¾ªç¯çš„ä¸€ä¸ªå•ç‹¬é˜¶æ®µè¿è¡Œã€‚å®ƒä½¿ç”¨ä¸€ä¸ª <code>libuv API</code>ï¼Œè¯¥ <code>API</code> åœ¨ <code>poll</code> é˜¶æ®µå®Œæˆåæ‰§è¡Œ <code>callback</code>ã€‚</p><ul><li><p><code>setImmediate()</code>å’Œ <code>setTimeout()</code>æ˜¯ç›¸ä¼¼çš„ï¼Œä½†æ ¹æ®å®ƒä»¬è¢«è°ƒç”¨çš„æ—¶é—´ä»¥ä¸åŒçš„æ–¹å¼è¡¨ç°ã€‚</p></li><li><p><code>setImmediate()</code>è®¾è®¡ç”¨äºåœ¨å½“å‰ <code>poll</code> é˜¶æ®µå®Œæˆå <code>check</code> é˜¶æ®µæ‰§è¡Œè„šæœ¬ ã€‚</p></li><li><p><code>setTimeout()</code> å®‰æ’åœ¨ç»è¿‡<code>æœ€å°ï¼ˆmsï¼‰</code>åè¿è¡Œçš„è„šæœ¬ï¼Œåœ¨ <code>timers</code> é˜¶æ®µæ‰§è¡Œã€‚</p></li></ul><p>ä¸¾ä¸ª ğŸŒ°ï¼š</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> fs </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">require</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">fs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFile</span><span style="color:#BABED8;">(__filename</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">setTimeout</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">timeout</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">},</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">setImmediate</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">immediate</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-lua line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">immediate</span></span>
<span class="line"><span style="color:#BABED8;">timeout</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>ä¸»è¦åŸå› æ˜¯åœ¨ <code>I/O</code> é˜¶æ®µè¯»å–æ–‡ä»¶åï¼Œäº‹ä»¶å¾ªç¯ä¼šå…ˆè¿›å…¥ <code>poll</code> é˜¶æ®µï¼Œå‘ç°æœ‰ <code>setImmediate</code> éœ€è¦æ‰§è¡Œï¼Œä¼šç«‹å³è¿›å…¥ check é˜¶æ®µæ‰§è¡Œ <code>setImmediate</code> çš„å›è°ƒã€‚ç„¶åå†è¿›å…¥ timers é˜¶æ®µï¼Œæ‰§è¡Œ <code>setTimeout</code>ï¼Œæ‰“å° <code>timeout</code>ã€‚</p><h3 id="setimmediate-ä¸-settimeout-çš„åŒºåˆ«" tabindex="-1"><code>setImmediate</code> ä¸ <code>setTimeout</code> çš„åŒºåˆ« <a class="header-anchor" href="#setimmediate-ä¸-settimeout-çš„åŒºåˆ«" aria-label="Permalink to &quot;\`setImmediate\` ä¸ \`setTimeout\` çš„åŒºåˆ«&quot;">â€‹</a></h3><p><code>setImmediate()</code>Â  å’Œ Â <code>setTimeout()</code>Â  å¾ˆç±»ä¼¼ï¼Œä½†æ˜¯åŸºäºè¢«è°ƒç”¨çš„æ—¶æœºï¼Œä»–ä»¬ä¹Ÿæœ‰ä¸åŒè¡¨ç°ã€‚</p><ol><li><code>setImmediate()</code>Â  è®¾è®¡ä¸ºä¸€æ—¦åœ¨å½“å‰ Â  è½®è¯¢ Â  é˜¶æ®µå®Œæˆï¼Œ å°±æ‰§è¡Œè„šæœ¬ã€‚</li><li><code>setTimeout()</code>Â  åœ¨æœ€å°é˜ˆå€¼ï¼ˆms å•ä½ï¼‰ï¼ˆå®šæ—¶å™¨æ—¶é—´åˆ°è¾¾ï¼‰è¿‡åè¿è¡Œè„šæœ¬ã€‚</li></ol><p>æ‰§è¡Œè®¡æ—¶å™¨çš„é¡ºåºå°†æ ¹æ®è°ƒç”¨å®ƒä»¬çš„ä¸Šä¸‹æ–‡è€Œå¼‚ã€‚</p><p><strong>å¦‚æœäºŒè€…éƒ½ä»ä¸»æ¨¡å—å†…è°ƒç”¨ï¼Œåˆ™è®¡æ—¶å™¨å°†å—è¿›ç¨‹æ€§èƒ½çš„çº¦æŸï¼ˆè¿™å¯èƒ½ä¼šå—åˆ°è®¡ç®—æœºä¸Šå…¶ä»–æ­£åœ¨è¿è¡Œåº”ç”¨ç¨‹åºçš„å½±å“ï¼‰ã€‚</strong></p><p>ä¾‹å¦‚ï¼Œå¦‚æœè¿è¡Œä»¥ä¸‹ä¸åœ¨ <code>I/O</code> å‘¨æœŸï¼ˆå³ä¸»æ¨¡å—ï¼‰å†…çš„è„šæœ¬ï¼Œåˆ™æ‰§è¡Œä¸¤ä¸ªè®¡æ—¶å™¨çš„é¡ºåºæ˜¯éç¡®å®šæ€§çš„ï¼Œå› ä¸ºå®ƒå—è¿›ç¨‹æ€§èƒ½çš„çº¦æŸï¼š</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#82AAFF;">setTimeout</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">timeout</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">0</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">setImmediate</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">immediate</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-lua line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">$ node timeout_vs_immediate.</span><span style="color:#FFCB6B;">js</span></span>
<span class="line"><span style="color:#BABED8;">timeout</span></span>
<span class="line"><span style="color:#BABED8;">immediate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">$ node timeout_vs_immediate.</span><span style="color:#FFCB6B;">js</span></span>
<span class="line"><span style="color:#BABED8;">immediate</span></span>
<span class="line"><span style="color:#BABED8;">timeout</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div>`,36)),s("p",null,[s("strong",null,[p(e,{color:"#FF4444"},{default:o(()=>a[1]||(a[1]=[n("ä½†æ˜¯ï¼Œå¦‚æœä½ æŠŠè¿™ä¸¤ä¸ªå‡½æ•°æ”¾å…¥ä¸€ä¸ª "),s("code",null,"I/O",-1),n(" å¾ªç¯å†…è°ƒç”¨ï¼Œ"),s("code",null,"setImmediate",-1),n(" æ€»æ˜¯è¢«ä¼˜å…ˆè°ƒç”¨ï¼šå› ä¸º "),s("code",null,"I/O",-1),n(" æ“ä½œæ˜¯åœ¨ "),s("code",null,"poll",-1),n(" é˜¶æ®µè¿›è¡Œçš„ï¼Œ"),s("code",null,"poll",-1),n(" é˜¶æ®µä¹‹åæ˜¯ "),s("code",null,"check",-1),n("ï¼ˆä¹Ÿå°±æ˜¯è°ƒç”¨ "),s("code",null,"setImmediate",-1),n("ï¼‰ã€‚")])),_:1})])]),a[4]||(a[4]=l(`<div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> fs </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">require</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">fs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// I/O  è½®è¯¢æ—¶ä¼šæ‰§è¡Œi/oå›è°ƒ å¦‚æœæ²¡æœ‰å®šä¹‰setImmediateä¼šç­‰å¾…å‰©ä¸‹çš„i/oå®Œæˆ æˆ–è€…å®šæ—¶å™¨åˆ°è¾¾æ—¶é—´</span></span>
<span class="line"><span style="color:#BABED8;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFile</span><span style="color:#BABED8;">(__filename</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">setTimeout</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">timeout</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">},</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">setImmediate</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// ä¸æ˜¯ç‰¹åˆ«é‡è¦çš„ä»»åŠ¡ å¯ä»¥æ”¾åˆ°setImmediate</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">immediate</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-lua line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">$ node timeout_vs_immediate.</span><span style="color:#FFCB6B;">js</span></span>
<span class="line"><span style="color:#BABED8;">immediate</span></span>
<span class="line"><span style="color:#BABED8;">timeout</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">$ node timeout_vs_immediate.</span><span style="color:#FFCB6B;">js</span></span>
<span class="line"><span style="color:#BABED8;">immediate</span></span>
<span class="line"><span style="color:#BABED8;">timeout</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>ä½¿ç”¨ Â <code>setImmediate()</code>Â  ç›¸å¯¹äº <code>setTimeout()</code>Â  çš„ä¸»è¦ä¼˜åŠ¿æ˜¯ï¼Œå¦‚æœ <code>setImmediate()</code>æ˜¯åœ¨ <code>I/O</code> å‘¨æœŸå†…è¢«è°ƒåº¦çš„ï¼Œé‚£å®ƒå°†ä¼šåœ¨å…¶ä¸­ä»»ä½•çš„å®šæ—¶å™¨ä¹‹å‰æ‰§è¡Œï¼Œè·Ÿè¿™é‡Œå­˜åœ¨å¤šå°‘ä¸ªå®šæ—¶å™¨æ— å…³ã€‚</strong></p><h2 id="close-callbacks" tabindex="-1"><code>close callbacks</code> <a class="header-anchor" href="#close-callbacks" aria-label="Permalink to &quot;\`close callbacks\`&quot;">â€‹</a></h2><p>å¦‚æœå¥—æ¥å­—æˆ–å¥æŸ„çªç„¶å…³é—­(ä¾‹å¦‚ <code>socket.destroy()</code>)ï¼Œé‚£ä¹ˆ<code>â€™closeâ€™</code>äº‹ä»¶å°†åœ¨è¿™ä¸ªé˜¶æ®µå‘å‡ºã€‚å¦åˆ™ï¼Œå®ƒå°†é€šè¿‡ <code>process.nextTick()</code>å‘å‡ºã€‚</p><p><code>process.nextTick()</code>æ–¹æ³•å°† <code>callback</code> æ·»åŠ åˆ° <code>next tick</code> é˜Ÿåˆ—ã€‚ ä¸€æ—¦å½“å‰äº‹ä»¶è½®è¯¢é˜Ÿåˆ—çš„ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼Œåœ¨ <code>next tick</code> é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ <code>callbacks</code> ä¼šè¢«ä¾æ¬¡è°ƒç”¨ã€‚å³ï¼Œå½“æ¯ä¸ªé˜¶æ®µå®Œæˆåï¼Œå¦‚æœå­˜åœ¨ <code>nextTick</code> é˜Ÿåˆ—ï¼Œå°±ä¼šæ¸…ç©ºé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”ä¼˜å…ˆäºå…¶ä»– <code>microtask</code> æ‰§è¡Œã€‚</p><p><code>Nodejs</code> ä¸æµè§ˆå™¨çš„ <code>Event Loop</code> å·®å¼‚ï¼š</p><ul><li><code>Node</code> ç«¯ï¼Œ<code>microtaskï¼ˆå¾®ä»»åŠ¡ï¼‰</code> åœ¨äº‹ä»¶å¾ªç¯çš„å„ä¸ªé˜¶æ®µä¹‹é—´æ‰§è¡Œã€‚</li><li>æµè§ˆå™¨ç«¯ï¼Œ<code>microtaskï¼ˆå¾®ä»»åŠ¡ï¼‰</code> åœ¨äº‹ä»¶å¾ªç¯çš„ <code>macrotaskï¼ˆå®ä»»åŠ¡ï¼‰</code>æ‰§è¡Œå®Œä¹‹åæ‰§è¡Œã€‚</li></ul><p><img src="https://steinsgate.oss-cn-hangzhou.aliyuncs.com/diff.png" alt="diff"></p>`,9))])}const E=c(d,[["render",y]]);export{A as __pageData,E as default};
