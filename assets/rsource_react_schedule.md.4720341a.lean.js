import{_ as c,B as r,o as t,c as i,N as p,x as n,a,D as e,z as o}from"./chunks/framework.2f525601.js";const E=JSON.parse('{"title":"Scheduler è°ƒåº¦å™¨","description":"","frontmatter":{},"headers":[],"relativePath":"rsource/react/schedule.md","lastUpdated":1729414590000}'),y={name:"rsource/react/schedule.md"};function F(D,s,u,b,d,m){const l=r("font");return t(),i("div",null,[s[7]||(s[7]=p(`<h1 id="scheduler-è°ƒåº¦å™¨" tabindex="-1">Scheduler è°ƒåº¦å™¨ <a class="header-anchor" href="#scheduler-è°ƒåº¦å™¨" aria-label="Permalink to &quot;Scheduler è°ƒåº¦å™¨&quot;">â€‹</a></h1><p><code>Scheduler</code>ä»–åŒ…å«ä¸¤ä¸ªåŠŸèƒ½ï¼š</p><ul><li><p>æ—¶é—´åˆ‡ç‰‡</p></li><li><p>ä¼˜å…ˆçº§è°ƒåº¦</p></li></ul><h2 id="æ—¶é—´åˆ‡ç‰‡" tabindex="-1">æ—¶é—´åˆ‡ç‰‡ <a class="header-anchor" href="#æ—¶é—´åˆ‡ç‰‡" aria-label="Permalink to &quot;æ—¶é—´åˆ‡ç‰‡&quot;">â€‹</a></h2><p>æ—¶é—´åˆ‡ç‰‡çš„æœ¬è´¨æ˜¯æ¨¡æ‹Ÿå®ç°<a href="/base/browser/api#requestidlecallback"><u>requestIdleCallback</u></a></p><div class="tip custom-block"><p class="custom-block-title">é‚£<code>React</code>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ <code>requestIdleCallback</code> ï¼Ÿ</p><ul><li>æµè§ˆå™¨å…¼å®¹æ€§</li><li>æ‰§è¡Œä»»åŠ¡çš„å¸§ç©ºé—²æ—¶é—´ä¸å¯æ§</li><li>è§¦å‘é¢‘ç‡ä¸ç¨³å®šï¼Œå—å¾ˆå¤šå› ç´ å½±å“</li></ul><p>åŸºäºä»¥ä¸ŠåŸå› ï¼Œ<code>React</code>å®ç°äº†åŠŸèƒ½æ›´å®Œå¤‡çš„<code>requestIdleCallback</code> <code>polyfill</code>ï¼Œè¿™å°±æ˜¯<code>Scheduler</code></p></div><p><code>Scheduler</code>çš„æ—¶é—´åˆ‡ç‰‡åŠŸèƒ½æ˜¯é€šè¿‡<code>task</code>ï¼ˆå®ä»»åŠ¡ï¼‰å®ç°çš„</p><p>æœ€å¸¸è§çš„<code>task</code>å½“å±<code>setTimeout</code>äº†ã€‚ä½†æ˜¯æœ‰ä¸ª<code>task</code>æ¯”<code>setTimeout</code>æ‰§è¡Œæ—¶æœºæ›´é å‰ï¼Œé‚£å°±æ˜¯<code>MessageChannel</code>ã€‚</p><p>æ‰€ä»¥<code>Scheduler</code>å°†éœ€è¦è¢«æ‰§è¡Œçš„å›è°ƒå‡½æ•°ä½œä¸º<code>MessageChannel</code>çš„å›è°ƒæ‰§è¡Œã€‚å¦‚æœå½“å‰å®¿ä¸»ç¯å¢ƒä¸æ”¯æŒ<code>MessageChannel</code>ï¼Œåˆ™ä½¿ç”¨<code>setTimeout</code>ã€‚</p><h2 id="ä¼˜å…ˆçº§è°ƒåº¦" tabindex="-1">ä¼˜å…ˆçº§è°ƒåº¦ <a class="header-anchor" href="#ä¼˜å…ˆçº§è°ƒåº¦" aria-label="Permalink to &quot;ä¼˜å…ˆçº§è°ƒåº¦&quot;">â€‹</a></h2><p><code>Scheduler</code>æ˜¯ç‹¬ç«‹äº<code>React</code>çš„åŒ…ï¼Œæ‰€ä»¥ä»–çš„ä¼˜å…ˆçº§ä¹Ÿæ˜¯ç‹¬ç«‹äº<code>React</code>çš„ä¼˜å…ˆçº§çš„</p><p><code>Scheduler</code>å†…éƒ¨å­˜åœ¨<code>5ç§</code>ä¼˜å…ˆçº§(<a href="https://github.com/azzlzzxz/react-source-code/blob/main/packages/scheduler/src/SchedulerPriorities.js" target="_blank" rel="noreferrer"><u>æºç åœ°å€ ï½œ SchedulerPriorities ğŸš€</u></a>):</p><ul><li><p><code>NoPriority = 0</code>ï¼šæ— ä¼˜å…ˆçº§</p></li><li><p><code>ImmediatePriority = 1</code>ï¼šç«‹åˆ»æ‰§è¡Œä¼˜å…ˆçº§</p></li><li><p><code>UserBlockingPriority = 2</code>ï¼šç”¨æˆ·é˜»å¡æ“ä½œä¼˜å…ˆçº§ï¼Œä¾‹å¦‚ï¼šç”¨æˆ·ç‚¹å‡» ï¼Œç”¨æˆ·è¾“å…¥ç­‰</p></li><li><p><code>NormalPriority = 3</code>ï¼šæ­£å¸¸ä¼˜å…ˆçº§</p></li><li><p><code>LowPriority = 4</code>ï¼šä½ä¼˜å…ˆçº§</p></li><li><p><code>IdlePriority = 5</code>ï¼šç©ºé—²ä¼˜å…ˆçº§</p></li></ul><h3 id="ä¼˜å…ˆçº§çš„æ„ä¹‰" tabindex="-1">ä¼˜å…ˆçº§çš„æ„ä¹‰ <a class="header-anchor" href="#ä¼˜å…ˆçº§çš„æ„ä¹‰" aria-label="Permalink to &quot;ä¼˜å…ˆçº§çš„æ„ä¹‰&quot;">â€‹</a></h3><p><code>Scheduler</code>å¯¹å¤–æš´éœ²æœ€é‡è¦çš„æ–¹æ³•ä¾¿æ˜¯<code>unstable_scheduleCallback</code>ã€‚è¯¥æ–¹æ³•ç”¨äºä»¥æŸä¸ªä¼˜å…ˆçº§æ³¨å†Œå›è°ƒå‡½æ•°</p><p>ä¸åŒä¼˜å…ˆçº§æ„å‘³ç€ä¸åŒæ—¶é•¿çš„ä»»åŠ¡è¿‡æœŸæ—¶é—´ï¼š</p><ul><li><p><code>IMMEDIATE_PRIORITY_TIMEOUT = -1</code>ï¼šç«‹åˆ»è¿‡æœŸ</p></li><li><p><code>USER_BLOCKING_PRIORITY_TIMEOUT = 250</code>ï¼šç”¨æˆ·é˜»å¡ä¼˜å…ˆçº§ 250 æ¯«ç§’</p></li><li><p><code>NORMAL_PRIORITY_TIMEOUT = 5000</code>ï¼šæ­£å¸¸ä¼˜å…ˆçº§çš„è¿‡æœŸæ—¶é—´ 5 ç§’</p></li><li><p><code>LOW_PRIORITY_TIMEOUT = 10000</code>ï¼šä½ä¼˜å…ˆçº§è¿‡æœŸæ—¶é—´ 10 ç§’</p></li><li><p><code>IDLE_PRIORITY_TIMEOUT = maxSigned31BitInt = 1073741823</code>ï¼šæ°¸ä¸è¿‡æœŸ</p></li></ul><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> timeout</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// ä»»åŠ¡çš„å¼€å§‹æ—¶é—´</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> startTime </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> performance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#BABED8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">switch</span><span style="color:#BABED8;"> (priorityLevel) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#BABED8;"> ImmediatePriority</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">    timeout </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> IMMEDIATE_PRIORITY_TIMEOUT</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#BABED8;"> UserBlockingPriority</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">    timeout </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> USER_BLOCKING_PRIORITY_TIMEOUT</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#BABED8;"> IdlePriority</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">    timeout </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> IDLE_PRIORITY_TIMEOUT</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#BABED8;"> LowPriority</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">    timeout </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> LOW_PRIORITY_TIMEOUT</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#BABED8;"> NormalPriority</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">    timeout </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> NORMAL_PRIORITY_TIMEOUT</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// ä»»åŠ¡è¿‡æœŸæ—¶é—´</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> expirationTime </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> startTime </span><span style="color:#89DDFF;">+</span><span style="color:#BABED8;"> timeout</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä¸€ä¸ªä»»åŠ¡çš„ä¼˜å…ˆçº§æ˜¯<code>ImmediatePriority</code>ï¼Œå¯¹åº”<code>IMMEDIATE_PRIORITY_TIMEOUT</code>ä¸º<code>-1</code>ï¼Œé‚£ä¹ˆ</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> expirationTime </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> startTime </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>åˆ™è¯¥ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´æ¯”å½“å‰æ—¶é—´è¿˜çŸ­ï¼Œè¡¨ç¤ºä»–å·²ç»è¿‡æœŸäº†ï¼Œéœ€è¦ç«‹å³è¢«æ‰§è¡Œã€‚</p><h3 id="ä¸åŒä¼˜å…ˆçº§ä»»åŠ¡çš„æ’åº" tabindex="-1">ä¸åŒä¼˜å…ˆçº§ä»»åŠ¡çš„æ’åº <a class="header-anchor" href="#ä¸åŒä¼˜å…ˆçº§ä»»åŠ¡çš„æ’åº" aria-label="Permalink to &quot;ä¸åŒä¼˜å…ˆçº§ä»»åŠ¡çš„æ’åº&quot;">â€‹</a></h3><p>ä¼˜å…ˆçº§æ„å‘³ç€ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´ã€‚è®¾æƒ³ä¸€ä¸ªå¤§å‹ <code>React</code> é¡¹ç›®ï¼Œåœ¨æŸä¸€åˆ»ï¼Œå­˜åœ¨å¾ˆå¤šä¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œå¯¹åº”ä¸åŒçš„è¿‡æœŸæ—¶é—´ã€‚</p><p>åŒæ—¶ï¼Œåˆå› ä¸ºä»»åŠ¡å¯ä»¥è¢«å»¶è¿Ÿï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†è¿™äº›ä»»åŠ¡æŒ‰æ˜¯å¦è¢«å»¶è¿Ÿåˆ†ä¸ºï¼š</p><ul><li><p>å·²å°±ç»ªä»»åŠ¡</p></li><li><p>æœªå°±ç»ªä»»åŠ¡</p></li></ul><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#BABED8;"> options </span><span style="color:#89DDFF;">===</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">object</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#BABED8;"> options </span><span style="color:#89DDFF;">!==</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">null</span><span style="color:#BABED8;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">var</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">delay</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">options</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">delay</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">delay</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">number</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">delay</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// ä»»åŠ¡è¢«å»¶è¿Ÿ</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">startTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">currentTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">delay</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">startTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">currentTime</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">startTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">currentTime</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>Scheduler</code>å­˜åœ¨ä¸¤ä¸ªé˜Ÿåˆ—ï¼š</p><ul><li><p><code>timerQueue</code>ï¼šä¿å­˜æœªå°±ç»ªä»»åŠ¡</p></li><li><p><code>taskQueue</code>ï¼šä¿å­˜å·²å°±ç»ªä»»åŠ¡</p></li></ul><p>æ¯å½“æœ‰æ–°çš„æœªå°±ç»ªçš„ä»»åŠ¡è¢«æ³¨å†Œï¼Œæˆ‘ä»¬å°†å…¶æ’å…¥<code>timerQueue</code>å¹¶æ ¹æ®å¼€å§‹æ—¶é—´é‡æ–°æ’åˆ—<code>timerQueue</code>ä¸­ä»»åŠ¡çš„é¡ºåºã€‚</p><p>å½“<code>timerQueue</code>ä¸­æœ‰ä»»åŠ¡å°±ç»ªï¼Œå³<code>startTime &lt;= currentTime</code>ï¼Œæˆ‘ä»¬å°†å…¶å–å‡ºå¹¶åŠ å…¥<code>taskQueue</code>ã€‚</p><div class="tip custom-block"><p class="custom-block-title"><code>currentTime</code></p><ul><li>è·å–å½“å‰æ—¶é—´</li></ul><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> currentTime </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> performance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#BABED8;">()</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></div><p>å–å‡º<code>taskQueue</code>ä¸­æœ€æ—©è¿‡æœŸçš„ä»»åŠ¡å¹¶æ‰§è¡Œä»–ã€‚</p><p>ä¸ºäº†èƒ½åœ¨<code>O(1)å¤æ‚åº¦</code>æ‰¾åˆ°ä¸¤ä¸ªé˜Ÿåˆ—ä¸­æ—¶é—´æœ€æ—©çš„é‚£ä¸ªä»»åŠ¡ï¼Œ<code>Scheduler</code>ä½¿ç”¨<code>æœ€å°å †</code>å®ç°äº†ä¼˜å…ˆçº§é˜Ÿåˆ—</p><hr><p><strong>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ React æ˜¯å¦‚ä½•å®ç°<code>Scheduler</code>çš„</strong></p><h2 id="scheduler-js" tabindex="-1"><code>Scheduler.js</code> <a class="header-anchor" href="#scheduler-js" aria-label="Permalink to &quot;\`Scheduler.js\`&quot;">â€‹</a></h2><ul><li><p><code>push</code>ã€<code>peek</code>ã€<code>pop</code>æ–¹æ³•å‡å±äºæœ€å°å †çš„æ–¹æ³•</p><ul><li><p>å…³äºæœ€å°å †çš„å®ç°å¯ä»¥çœ‹<a href="/rsource/react/preknowledge#æœ€å°å †">å‰ç½®çŸ¥è¯†ï½œæœ€å°å †</a></p></li><li><p><a href="https://github.com/azzlzzxz/react-source-code/blob/main/packages/scheduler/src/SchedulerMinHeap.js" target="_blank" rel="noreferrer"><u>React æºç  æœ€å°å †çš„å®ç° ï½œ SchedulerMinHeap.js</u></a></p></li></ul></li><li><p><code>scheduleCallback</code>å‡½æ•°ï¼šæŒ‰ä¼˜å…ˆçº§æ‰§è¡Œä»»åŠ¡</p></li><li><p><code>requestHostCallback</code>å‡½æ•°ï¼šé€šè¿‡<code>MessageChannel</code>ï¼Œå¼€å§‹æ‰§è¡Œä»»åŠ¡<code>performWorkUntilDeadline</code></p></li><li><p><code>performWorkUntilDeadline</code>å‡½æ•°ï¼šä»æœ€å°å †ä¸­ä¾æ¬¡å–å‡ºä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡å¾ªç¯æ‰§è¡Œï¼Œç›´åˆ°æ²¡æœ‰ä»»åŠ¡éœ€è¦è¢«æ‰§è¡Œ</p><ul><li><p><code>workLoop</code>: æ‰§è¡Œä»»åŠ¡</p></li><li><p><code>shouldYieldToHost</code>ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æ”¾å¼ƒæ‰§è¡Œä»»åŠ¡</p></li></ul></li></ul><blockquote><p>æµç¨‹å›¾</p></blockquote><p><img src="https://steinsgate.oss-cn-hangzhou.aliyuncs.com/react/schedule_flow.jpg" alt="schedule_flow"></p><h3 id="schedulecallback" tabindex="-1"><code>scheduleCallback</code> <a class="header-anchor" href="#schedulecallback" aria-label="Permalink to &quot;\`scheduleCallback\`&quot;">â€‹</a></h3>`,40)),n("ul",null,[n("li",null,[n("p",null,[s[1]||(s[1]=a("æ ¹æ®ä¼˜å…ˆçº§ï¼Œè®¡ç®—ä»»åŠ¡è¿‡æœŸæ—¶é—´ï¼ˆ")),n("strong",null,[e(l,{color:"#FF4229"},{default:o(()=>s[0]||(s[0]=[a("ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´ æ˜¯ä¸€ä¸ª ç»å¯¹å€¼ ä¸ä¼šæ”¹å˜")])),_:1})]),s[2]||(s[2]=a("ï¼‰"))])]),s[6]||(s[6]=n("li",null,[n("p",null,"åˆ›å»ºä¸€ä¸ªä»»åŠ¡")],-1)),n("li",null,[n("p",null,[s[4]||(s[4]=a("å‘ä»»åŠ¡æœ€å°å †é‡Œæ·»åŠ ä»»åŠ¡ï¼Œæ’åºçš„ä¾æ®æ˜¯è¿‡æœŸæ—¶é—´ï¼ˆ")),n("strong",null,[e(l,{color:"#FF4229"},{default:o(()=>s[3]||(s[3]=[a("ä¸¥æ ¼æŒ‰ç…§ è¿‡æœŸæ—¶é—´ è¿›è¡Œè°ƒåº¦")])),_:1})]),s[5]||(s[5]=a("ï¼‰"))])])]),s[8]||(s[8]=p(`<div class="tip custom-block"><p class="custom-block-title">é«˜ä¼˜å…ˆçº§å…ˆæ‰§è¡Œï¼Œä½ä¼˜å…ˆçº§åæ‰§è¡Œ</p><ul><li>å¦‚æœæœ€å°å †é‡Œçš„ä½ä¼˜å…ˆçº§ä»»åŠ¡å‰é¢çš„é«˜ä¼˜å…ˆçº§ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•äº†ï¼Œè¿™æ—¶åˆæ¥äº†ä¸€ä¸ªé«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œè¯¥æ€ä¹ˆæ‰§è¡Œï¼Ÿ</li></ul><p>è¿˜æ˜¯ <strong><code>æ¯”è¾ƒè¿‡æœŸæ—¶é—´</code></strong>ï¼Œå³ä½¿æ¥çš„æ˜¯é«˜ä¼˜å…ˆçº§ï¼Œå¦‚æœ<code>ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´ æ¯” é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡è¿‡æœŸæ—¶é—´é•¿</code>ï¼Œå°±ä¼š<code>å…ˆæ‰§è¡Œè¿™ä¸ª è¿‡æœŸæ—¶é—´é•¿çš„ä½ä¼˜å…ˆçº§ä»»åŠ¡</code></p><ul><li>å¦‚æœä¸€ä¸ªä»»åŠ¡å·²ç»è¿‡æœŸäº†ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ˜¯ä¸èƒ½è¢«æ‰“æ–­çš„</li></ul></div><ul><li>è°ƒç”¨<code>requestHostCallback</code>å¼€å§‹æ‰§è¡Œä»»åŠ¡</li></ul><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">getCurrentTime</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">performance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * æŒ‰ä¼˜å…ˆçº§æ‰§è¡Œä»»åŠ¡</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#89DDFF;font-style:italic;">{</span><span style="color:#FFCB6B;font-style:italic;">*</span><span style="color:#89DDFF;font-style:italic;">}</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#BABED8;font-style:italic;">priorityLevel</span><span style="color:#676E95;font-style:italic;"> ä¼˜å…ˆçº§çš„çº§åˆ«</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#89DDFF;font-style:italic;">{</span><span style="color:#FFCB6B;font-style:italic;">*</span><span style="color:#89DDFF;font-style:italic;">}</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#BABED8;font-style:italic;">callback</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">scheduleCallback</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">priorityLevel</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">callback</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// è·å–å½“å‰çš„æ—¶å€™</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">currentTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">getCurrentTime</span><span style="color:#F07178;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ­¤ä»»åŠ¡çš„å¼€æ—¶é—´</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">startTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">currentTime</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//è¶…æ—¶æ—¶é—´</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">timeout</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//æ ¹æ®ä¼˜å…ˆçº§è®¡ç®—è¿‡æœŸçš„æ—¶é—´</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">switch</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">priorityLevel</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">ImmediatePriority</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#BABED8;">timeout</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">IMMEDIATE_PRIORITY_TIMEOUT</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// -1</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">UserBlockingPriority</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#BABED8;">timeout</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">USER_BLOCKING_PRIORITY_TIMEOUT</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 250 ms</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">IdlePriority</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#BABED8;">timeout</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">IDLE_PRIORITY_TIMEOUT</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 1073741823</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">LowPriority</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#BABED8;">timeout</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">LOW_PRIORITY_TIMEOUT</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 1000</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">NormalPriority</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#BABED8;">timeout</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">NORMAL_PRIORITY_TIMEOUT</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 500</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//è®¡ç®—æ­¤ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">expirationTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">startTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">timeout</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">newTask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    id</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">taskIdCounter</span><span style="color:#89DDFF;">++,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">callback</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// å›è°ƒå‡½æ•°æˆ–è€…è¯´ä»»åŠ¡å‡½æ•°</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">priorityLevel</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// ä¼˜å…ˆçº§åˆ«</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">startTime</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// ä»»åŠ¡çš„å¼€å§‹æ—¶é—´</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">expirationTime</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´</span></span>
<span class="line"><span style="color:#F07178;">    sortIndex</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">expirationTime</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// æ’åºä¾æ®</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å‘ä»»åŠ¡æœ€å°å †é‡Œæ·»åŠ ä»»åŠ¡ï¼Œæ’åºçš„ä¾æ®æ˜¯è¿‡æœŸæ—¶é—´</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">push</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">taskQueue</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">newTask</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// flushWorkæ‰§è¡Œå·¥ä½œï¼Œåˆ·æ–°å·¥ä½œï¼Œæ‰§è¡Œä»»åŠ¡</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">requestHostCallback</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">flushWork</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">newTask</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h3 id="requesthostcallback" tabindex="-1"><code>requestHostCallback</code> <a class="header-anchor" href="#requesthostcallback" aria-label="Permalink to &quot;\`requestHostCallback\`&quot;">â€‹</a></h3><ul><li><p>ç¼“å­˜å›è°ƒå‡½æ•°</p></li><li><p>é€šè¿‡<code>MessageChannel</code>è¿™ä¸ªå®ä»»åŠ¡ï¼Œå®ç°ç±»ä¼¼äº<code>requestIdleCallback</code></p></li></ul><blockquote><p>æµç¨‹å›¾</p></blockquote><p><img src="https://steinsgate.oss-cn-hangzhou.aliyuncs.com/react/scheduler_method.jpg" alt="scheduler_method"></p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> channel </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">MessageChannel</span><span style="color:#BABED8;">()</span></span>
<span class="line"><span style="color:#C792EA;">var</span><span style="color:#BABED8;"> port2 </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> channel</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">port2</span></span>
<span class="line"><span style="color:#C792EA;">var</span><span style="color:#BABED8;"> port1 </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> channel</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">port1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">port1</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">onmessage </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> performWorkUntilDeadline</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">requestHostCallback</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">flushWork</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//å…ˆç¼“å­˜å›è°ƒå‡½æ•°</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">scheduleHostCallback</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">flushWork</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//æ‰§è¡Œå·¥ä½œç›´åˆ°æˆªæ­¢æ—¶é—´</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">schedulePerformWorkUntilDeadline</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// å¼€å§‹æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">flushWork</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">startTime</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">workLoop</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">startTime</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">schedulePerformWorkUntilDeadline</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">port2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">postMessage</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="performworkuntildeadline" tabindex="-1"><code>performWorkUntilDeadline</code> <a class="header-anchor" href="#performworkuntildeadline" aria-label="Permalink to &quot;\`performWorkUntilDeadline\`&quot;">â€‹</a></h3><ul><li>æ‰§è¡Œä»»åŠ¡å¾ªç¯ï¼Œç›´åˆ°æ²¡æœ‰ä»»åŠ¡éœ€è¦è¢«æ‰§è¡Œ</li></ul><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">performWorkUntilDeadline</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">scheduleHostCallback</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å…ˆè·å–å¼€å§‹æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´, è¡¨ç¤ºæ—¶é—´ç‰‡çš„å¼€å§‹</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">startTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">getCurrentTime</span><span style="color:#F07178;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æ˜¯å¦æœ‰æ›´å¤šçš„å·¥ä½œè¦åš</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">hasMoreWork</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">//æ‰§è¡ŒworkLoopï¼Œå¹¶åˆ¤æ–­æœ‰æ²¡æœ‰è¿”å›å€¼</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#BABED8;">hasMoreWork</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">scheduleHostCallback</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">startTime</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">finally</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// æ‰§è¡Œå®Œä»¥åå¦‚æœä¸ºtrue,è¯´æ˜è¿˜æœ‰æ›´å¤šå·¥ä½œè¦åš</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">hasMoreWork</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// ç»§ç»­æ‰§è¡Œ workLoop</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">schedulePerformWorkUntilDeadline</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#BABED8;">scheduleHostCallback</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="workloop-å¼€å§‹å·¥ä½œå¾ªç¯" tabindex="-1"><code>workLoop</code> å¼€å§‹å·¥ä½œå¾ªç¯ <a class="header-anchor" href="#workloop-å¼€å§‹å·¥ä½œå¾ªç¯" aria-label="Permalink to &quot;\`workLoop\` å¼€å§‹å·¥ä½œå¾ªç¯&quot;">â€‹</a></h3><ul><li><p>ä»æœ€å°å †ä¸­å–å‡ºä¼˜å…ˆçº§æœ€é«˜çš„çš„ä»»åŠ¡ï¼Œå¼€å§‹æ‰§è¡Œå·¥ä½œå¾ªç¯</p></li><li><p>æ‰§è¡Œ<code>scheduleCallback</code>å‡½æ•°ï¼Œä¼ å…¥çš„<code>callback</code>å›è°ƒå‡½æ•°ï¼Œåˆ¤æ–­<code>callback</code>çš„è¿”å›æ˜¯å¦æ˜¯å‡½æ•°</p><ul><li><p>å¦‚æœæ˜¯å‡½æ•°ï¼Œè¯´æ˜è¿˜æœ‰ä»»åŠ¡éœ€è¦æ‰§è¡Œï¼Œ<code>return true</code>ï¼Œä»»åŠ¡å·²ç»å®Œæˆï¼Œåˆ™ä¸éœ€è¦å†ç»§ç»­æ‰§è¡Œäº†ï¼Œå¯ä»¥æŠŠæ­¤ä»»åŠ¡å¼¹å‡º<code>pop(taskQueue)</code></p></li><li><p>å¦åˆ™å°±ç›´æ¥æŠŠæ­¤ä»»åŠ¡å¼¹å‡º<code>pop(taskQueue)</code></p></li></ul></li><li><p>å¦‚æœå½“å‰çš„ä»»åŠ¡æ‰§è¡Œå®Œäº†ï¼Œæˆ–è€…å½“å‰ä»»åŠ¡ä¸åˆæ³•ï¼Œå–å‡ºä¸‹ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ<code>currentTask = peek(taskQueue)</code></p></li><li><p>æ²¡æœ‰ä»»ä½•è¦å®Œæˆçš„ä»»åŠ¡äº† <code>return false</code></p></li></ul><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">workLoop</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">startTime</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">currentTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">startTime</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å–å‡ºä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">currentTask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">peek</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">taskQueue</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">currentTask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å¦‚æœæ­¤ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´å°äºå½“å‰æ—¶é—´ï¼Œè¯´æ˜ä»»åŠ¡æ²¡æœ‰è¿‡æœŸï¼Œå¹¶ä¸”éœ€è¦æ”¾å¼ƒæ‰§è¡Œï¼Œæ—¶é—´ç‰‡åˆ°æœŸ</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">currentTask</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">expirationTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">currentTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">shouldYieldToHost</span><span style="color:#F07178;">()) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// è·³å‡ºå·¥ä½œå¾ªç¯</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å–å‡ºå½“å‰çš„ä»»åŠ¡ä¸­çš„å›è°ƒå‡½æ•° ï¼ˆscheduleCallbacké‡Œçš„callbackå›è°ƒå‡½æ•°ï¼‰</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">callback</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">currentTask</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">callback</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">callback</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">function</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#BABED8;">currentTask</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">callback</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// å›è°ƒå‡½æ•°æ˜¯å¦è¿‡æœŸ</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">didUserCallbackTimeout</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">currentTask</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">expirationTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">currentTime</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// æ‰§è¡Œå·¥ä½œï¼Œå¦‚æœè¿”å›æ–°çš„å‡½æ•°ï¼Œåˆ™è¡¨ç¤ºå½“å‰çš„å·¥ä½œæ²¡æœ‰å®Œæˆ</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">continuationCallback</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">callback</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">didUserCallbackTimeout</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">continuationCallback</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">function</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#BABED8;">currentTask</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">callback</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">continuationCallback</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// è¿˜æœ‰ä»»åŠ¡è¦æ‰§è¡Œ</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// å¦‚æœæ­¤ä»»åŠ¡å·²ç»å®Œæˆï¼Œåˆ™ä¸éœ€è¦å†ç»§ç»­æ‰§è¡Œäº†ï¼Œå¯ä»¥æŠŠæ­¤ä»»åŠ¡å¼¹å‡º</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">currentTask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">peek</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">taskQueue</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">pop</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">taskQueue</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">pop</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">taskQueue</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å¦‚æœå½“å‰çš„ä»»åŠ¡æ‰§è¡Œå®Œäº†ï¼Œæˆ–è€…å½“å‰ä»»åŠ¡ä¸åˆæ³•ï¼Œå–å‡ºä¸‹ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">currentTask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">peek</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">taskQueue</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å¦‚æœå¾ªç¯ç»“æŸè¿˜æœ‰æœªå®Œæˆçš„ä»»åŠ¡ï¼Œé‚£å°±è¡¨ç¤ºhasMoreWork=true</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">currentTask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ²¡æœ‰ä»»ä½•è¦å®Œæˆçš„ä»»åŠ¡äº†</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h3 id="shouldyieldtohost" tabindex="-1"><code>shouldYieldToHost</code> <a class="header-anchor" href="#shouldyieldtohost" aria-label="Permalink to &quot;\`shouldYieldToHost\`&quot;">â€‹</a></h3><ul><li><p><code>frameInterval</code>ï¼š<code>React</code>ä¼šåœ¨æ¯ä¸€å¸§å‘æµè§ˆå™¨ç”³è¯·<code>5ms</code>ç”¨äºè‡ªå·±ä»»åŠ¡æ‰§è¡Œï¼Œå¦‚æœ<code>5ms</code>å†…æ²¡æœ‰å®Œæˆï¼Œ<code>React</code>å°±ä¼šæ”¾å¼ƒæ§åˆ¶æƒï¼ŒæŠŠæ§åˆ¶æƒäº¤è¿˜ç»™æµè§ˆå™¨</p></li><li><p><code>shouldYieldToHost</code>å‡½æ•°ï¼šé€šè¿‡è¿‡å»çš„æ—¶é—´å’Œ<code>frameInterval</code>è¿›è¡Œæ¯”è¾ƒï¼Œæ¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¿‡æœŸï¼Œè·³å‡ºå·¥ä½œå¾ªç¯</p></li></ul><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> frameInterval </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">shouldYieldToHost</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// ç”¨å½“å‰æ—¶é—´å‡å»å¼€å§‹çš„æ—¶é—´å°±æ˜¯è¿‡å»çš„æ—¶é—´</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">timeElapsed</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">getCurrentTime</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">startTime</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//å¦‚æœè¯´ç»è¿‡çš„æ—¶é—´å°äº5msï¼Œé‚£å°±ä¸éœ€è¦æ”¾å¼ƒæ‰§è¡Œ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">timeElapsed</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">frameInterval</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å¦åˆ™å°±æ˜¯è¡¨ç¤º5msç”¨å®Œäº†ï¼Œéœ€è¦æ”¾å¼ƒæ‰§è¡Œ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="unstable-cancelcallback-å–æ¶ˆä»»åŠ¡" tabindex="-1"><code>unstable_cancelCallback</code> å–æ¶ˆä»»åŠ¡ <a class="header-anchor" href="#unstable-cancelcallback-å–æ¶ˆä»»åŠ¡" aria-label="Permalink to &quot;\`unstable_cancelCallback\` å–æ¶ˆä»»åŠ¡&quot;">â€‹</a></h3><ul><li>åœ¨<code>workLoop</code>ä¸­ï¼Œä¼šåˆ¤æ–­<code>continuationCallback</code>æ˜¯ä¸æ˜¯å‡½æ•°ï¼Œä¸æ˜¯çš„è¯ç›´æ¥å‡ºé˜Ÿ</li></ul><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">unstable_cancelCallback</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">task</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">task</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">callback</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">æºç åœ°å€</p><p>å®ç°<code>Scheduler</code>çš„ç›¸å…³ä»£ç æˆ‘æ”¾åœ¨äº†<a href="https://github.com/azzlzzxz/react-code/tree/13.scheduler" target="_blank" rel="noreferrer"><u>13.scheduler åˆ†æ”¯é‡Œäº† ç‚¹å‡»ç›´è¾¾ ğŸš€</u></a></p></div><div class="info custom-block"><p class="custom-block-title">ç›¸å…³èµ„æ–™</p><ul><li><a href="https://react.iamkasong.com/concurrent/scheduler.html" target="_blank" rel="noreferrer">Scheduler çš„åŸç†ä¸å®ç°</a></li></ul></div>`,22))])}const A=c(y,[["render",F]]);export{E as __pageData,A as default};
