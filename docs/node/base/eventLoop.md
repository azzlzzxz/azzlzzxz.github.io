# Node çš„äº‹ä»¶å¾ªç¯æœºåˆ¶

![node_eventLoop](https://steinsgate.oss-cn-hangzhou.aliyuncs.com/Node_EventLoop.jpg)

## `event loop` æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹

å½“ `Node.js` å¯åŠ¨æ—¶ï¼Œå®ƒåˆå§‹åŒ–äº‹ä»¶å¾ªç¯ï¼Œå¤„ç†æä¾›çš„è¾“å…¥è„šæœ¬ï¼Œè¿™äº›è„šæœ¬å¯èƒ½è¿›è¡Œå¼‚æ­¥ `API` è°ƒç”¨ã€è°ƒåº¦è®¡æ—¶å™¨æˆ–è°ƒç”¨ `process.nextTick()`ï¼Œç„¶åå¼€å§‹å¤„ç†äº‹ä»¶å¾ªç¯ã€‚

```lua
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€>â”‚        timers         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚     pending callbacks â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚     idle, prepare     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   incoming:   â”‚
â”‚  â”‚         poll          â”‚<â”€â”€â”€â”€â”€â”¤  connections, â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   data, etc.  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚        check          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”¤    close callbacks    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

::: tip æµç¨‹

- `timers:` æ‰§è¡Œ `setTimeout` å’Œ `setInterval` ä¸­åˆ°æœŸçš„ `callback`ã€‚
- `pending callback:` ä¸Šä¸€è½®å¾ªç¯ä¸­å°‘æ•°çš„ `callback` ä¼šæ”¾åœ¨è¿™ä¸€é˜¶æ®µæ‰§è¡Œã€‚
- `idle, prepare:` ä»…åœ¨å†…éƒ¨ä½¿ç”¨ã€‚
- `poll:` æœ€é‡è¦çš„é˜¶æ®µï¼Œæ‰§è¡Œ `pending` `callback`ï¼Œåœ¨é€‚å½“çš„æƒ…å†µä¸‹ä¼šé˜»å¡åœ¨è¿™ä¸ªé˜¶æ®µã€‚
- `check:` æ‰§è¡Œ `setImmediate` çš„ `callback`ã€‚

> `setImmediate()`æ˜¯å°†äº‹ä»¶æ’å…¥åˆ°äº‹ä»¶é˜Ÿåˆ—å°¾éƒ¨ï¼Œä¸»çº¿ç¨‹å’Œäº‹ä»¶é˜Ÿåˆ—çš„å‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åç«‹å³æ‰§è¡Œ `setImmediate` æŒ‡å®šçš„å›è°ƒå‡½æ•°

- `close callbacks:` æ‰§è¡Œ close äº‹ä»¶çš„ `callback`ï¼Œä¾‹å¦‚ `socket.on(â€˜closeâ€™[,fn])`æˆ–è€… `http.server.on('close, fn)`ã€‚

:::

`event loop` çš„æ¯ä¸€æ¬¡å¾ªç¯éƒ½éœ€è¦ä¾æ¬¡ç»è¿‡ä¸Šè¿°çš„é˜¶æ®µã€‚

æ¯ä¸ªé˜¶æ®µéƒ½æœ‰è‡ªå·±çš„ `FIFO` çš„ `callback` é˜Ÿåˆ—ï¼ˆåœ¨ `timer` é˜¶æ®µå…¶å®ä½¿ç”¨ä¸€ä¸ª[<u>æœ€å°å †</u>](/rsource/react/preknowledge.md#æœ€å°å †)è€Œä¸æ˜¯é˜Ÿåˆ—æ¥ä¿å­˜æ‰€æœ‰å…ƒç´ ï¼Œæ¯”å¦‚ `timeout` çš„ `callback` æ˜¯æŒ‰ç…§è¶…æ—¶æ—¶é—´çš„é¡ºåºæ¥è°ƒç”¨çš„ï¼Œå¹¶ä¸æ˜¯å…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—é€»è¾‘ï¼‰ï¼Œæ¯å½“è¿›å…¥æŸä¸ªé˜¶æ®µï¼Œéƒ½ä¼šä»æ‰€å±çš„é˜Ÿåˆ—ä¸­å–å‡º `callback` æ¥æ‰§è¡Œã€‚

å½“é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…è¢«æ‰§è¡Œ `callback` çš„æ•°é‡è¾¾åˆ°ç³»ç»Ÿçš„æœ€å¤§æ•°é‡æ—¶ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚è¿™å…­ä¸ªé˜¶æ®µéƒ½æ‰§è¡Œå®Œæ¯•ç§°ä¸ºä¸€è½®å¾ªç¯ã€‚

## `timers`

> æºç åœ°å€ [uv\_\_run_timers](https://github.com/nodejs/node/blob/23a3410f9fecf2c8652eef4f92b4072edf307137/deps/uv/src/timer.c#L163)

åœ¨ `timers` é˜¶æ®µï¼Œä¼šæ‰§è¡Œ `setTimeout` å’Œ `setInterval` ä¸­åˆ°æœŸçš„ `callback`ã€‚æ‰§è¡Œè¿™ä¸¤è€…å›è°ƒéœ€è¦è®¾ç½®ä¸€ä¸ªæ¯«ç§’æ•°ï¼Œç†è®ºä¸Šæ¥è¯´ï¼Œåº”è¯¥æ˜¯æ—¶é—´ä¸€åˆ°å°±ç«‹å³æ‰§è¡Œ `callback` å›è°ƒï¼Œä½†æ˜¯ç”±äº `system` çš„è°ƒåº¦å¯èƒ½ä¼šå»¶æ—¶ï¼Œè¾¾ä¸åˆ°é¢„æœŸæ—¶é—´ã€‚

> ä¸¾ä¸ª ğŸŒ°

```js
const fs = require('fs')

function someAsyncOperation(callback) {
  fs.readFile('/path/to/file', callback)
}

const timeoutScheduled = Date.now()

setTimeout(() => {
  const delay = Date.now() - timeoutScheduled

  console.log(`${delay}ms have passed since I was scheduled`)
}, 100)

someAsyncOperation(() => {
  const startCallback = Date.now()

  while (Date.now() - startCallback < 10) {
    // do nothing
  }
})
```

å½“è¿›å…¥äº‹ä»¶å¾ªç¯æ—¶ï¼Œå®ƒæœ‰ä¸€ä¸ªç©ºé˜Ÿåˆ—ï¼ˆ`fs.readFile()`å°šæœªå®Œæˆï¼‰ï¼Œå› æ­¤å®šæ—¶å™¨å°†ç­‰å¾…å‰©ä½™æ¯«ç§’æ•°ï¼Œå½“åˆ°è¾¾ `95ms`ï¼ˆå‡è®¾ `fs.readFile()`éœ€è¦ `95ms`ï¼‰æ—¶ï¼Œ`fs.readFile()`å®Œæˆè¯»å–æ–‡ä»¶å¹¶ä¸”å…¶å®Œæˆéœ€è¦ `10ms` çš„å›è°ƒè¢«æ·»åŠ åˆ°è½®è¯¢é˜Ÿåˆ—å¹¶æ‰§è¡Œã€‚

å› æ­¤ï¼ŒåŸæœ¬è®¾ç½® `100ms` åæ‰§è¡Œçš„å›è°ƒå‡½æ•°ï¼Œä¼šåœ¨çº¦ `105ms` åæ‰§è¡Œã€‚

## `pending callbacks`

æ­¤é˜¶æ®µæ‰§è¡ŒæŸäº›ç³»ç»Ÿæ“ä½œï¼ˆä¾‹å¦‚ `TCP` é”™è¯¯ç±»å‹ï¼‰çš„å›è°ƒã€‚

ä¾‹å¦‚ï¼šå¦‚æœ `TCP socket ECONNREFUSED` åœ¨å°è¯• `connect` æ—¶ `receives`ï¼Œ ç³»ç»Ÿå¸Œæœ›ç­‰å¾…æŠ¥å‘Šé”™è¯¯ï¼Œè¿™å°†åœ¨ `pending callbacks` é˜¶æ®µæ‰§è¡Œã€‚

## `poll`ï¼ˆè½®è¯¢ï¼‰

æ‰§è¡Œ `pending callback`ï¼Œåœ¨é€‚å½“çš„æƒ…å†µä¸‹ä¼šé˜»å¡åœ¨è¿™ä¸ªé˜¶æ®µã€‚

`poll` é‡Œé¢ æœ‰å¾ˆå¤šå›è°ƒ node ä¸­æœ‰æ‰§è¡Œçš„æœ€å¤§ä¸ªæ•°ï¼Œè¶…è¿‡æœ€å¤§ä¸ªæ•°ä¼šè¢«å»¶è¿Ÿåˆ°ä¸‹ä¸€è½®å¾ªç¯æ‰§è¡Œã€‚

`poll` é˜¶æ®µæœ‰ä¸¤ä¸ªä¸»è¦åŠŸèƒ½ï¼š

1. æ‰§è¡Œ `I/O`ï¼ˆè¿æ¥ã€æ•°æ®è¿›å…¥/è¾“å‡ºï¼‰å›è°ƒã€‚
2. å¤„ç†è½®è¯¢é˜Ÿåˆ—ä¸­çš„äº‹ä»¶ã€‚

å½“äº‹ä»¶å¾ªç¯è¿›å…¥ `poll` é˜¶æ®µå¹¶ä¸”åœ¨ `timers` ä¸­æ²¡æœ‰å¯ä»¥æ‰§è¡Œå®šæ—¶å™¨æ—¶ï¼š

- å¦‚æœ `poll` é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™äº‹ä»¶å¾ªç¯å°†éå†å…¶åŒæ­¥æ‰§è¡Œå®ƒä»¬çš„ `callback` é˜Ÿåˆ—ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–è€…è¾¾åˆ° system-dependentï¼ˆç³»ç»Ÿç›¸å…³é™åˆ¶ï¼‰ã€‚

- å¦‚æœ `poll` é˜Ÿåˆ—ä¸ºç©ºï¼Œä¼šæ£€æŸ¥æ˜¯å¦æœ‰ `setImmediate()`å›è°ƒéœ€è¦æ‰§è¡Œï¼Œå¦‚æœæœ‰åˆ™é©¬ä¸Šè¿›å…¥æ‰§è¡Œ `check` é˜¶æ®µä»¥æ‰§è¡Œå›è°ƒã€‚

- å¦‚æœ `timers` ä¸­æœ‰å¯ä»¥æ‰§è¡Œå®šæ—¶å™¨ä¸” `poll` é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œåˆ™ä¼šåˆ¤æ–­æ˜¯å¦æœ‰ `timer` è¶…æ—¶ï¼Œå¦‚æœæœ‰çš„è¯ä¼šå›åˆ° `timer` é˜¶æ®µæ‰§è¡Œå›è°ƒã€‚

## `check`

æ­¤é˜¶æ®µæ‰§è¡Œ `setImmediate` çš„ `callback`ã€‚

`setImmediate()`å®é™…ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è®¡æ—¶å™¨ï¼Œå®ƒåœ¨äº‹ä»¶å¾ªç¯çš„ä¸€ä¸ªå•ç‹¬é˜¶æ®µè¿è¡Œã€‚å®ƒä½¿ç”¨ä¸€ä¸ª `libuv API`ï¼Œè¯¥ `API` åœ¨ `poll` é˜¶æ®µå®Œæˆåæ‰§è¡Œ `callback`ã€‚

- `setImmediate()`å’Œ `setTimeout()`æ˜¯ç›¸ä¼¼çš„ï¼Œä½†æ ¹æ®å®ƒä»¬è¢«è°ƒç”¨çš„æ—¶é—´ä»¥ä¸åŒçš„æ–¹å¼è¡¨ç°ã€‚

- `setImmediate()`è®¾è®¡ç”¨äºåœ¨å½“å‰ `poll` é˜¶æ®µå®Œæˆå `check` é˜¶æ®µæ‰§è¡Œè„šæœ¬ ã€‚

- `setTimeout()` å®‰æ’åœ¨ç»è¿‡`æœ€å°ï¼ˆmsï¼‰`åè¿è¡Œçš„è„šæœ¬ï¼Œåœ¨ `timers` é˜¶æ®µæ‰§è¡Œã€‚

> ä¸¾ä¸ª ğŸŒ°

```js
const fs = require('fs')

fs.readFile(__filename, () => {
  setTimeout(() => {
    console.log('timeout')
  }, 0)
  setImmediate(() => {
    console.log('immediate')
  })
})
```

```lua
immediate
timeout
```

ä¸»è¦åŸå› æ˜¯åœ¨ `I/O` é˜¶æ®µè¯»å–æ–‡ä»¶åï¼Œäº‹ä»¶å¾ªç¯ä¼šå…ˆè¿›å…¥ `poll` é˜¶æ®µï¼Œå‘ç°æœ‰ `setImmediate` éœ€è¦æ‰§è¡Œï¼Œä¼šç«‹å³è¿›å…¥ check é˜¶æ®µæ‰§è¡Œ `setImmediate` çš„å›è°ƒã€‚ç„¶åå†è¿›å…¥ timers é˜¶æ®µï¼Œæ‰§è¡Œ `setTimeout`ï¼Œæ‰“å° `timeout`ã€‚

### `setImmediate` ä¸ `setTimeout` çš„åŒºåˆ«

`setImmediate()`Â  å’Œ Â `setTimeout()`Â  å¾ˆç±»ä¼¼ï¼Œä½†æ˜¯åŸºäºè¢«è°ƒç”¨çš„æ—¶æœºï¼Œä»–ä»¬ä¹Ÿæœ‰ä¸åŒè¡¨ç°ã€‚

1. `setImmediate()`Â  è®¾è®¡ä¸ºä¸€æ—¦åœ¨å½“å‰ Â  è½®è¯¢ Â  é˜¶æ®µå®Œæˆï¼Œ å°±æ‰§è¡Œè„šæœ¬ã€‚
2. `setTimeout()`Â  åœ¨æœ€å°é˜ˆå€¼ï¼ˆms å•ä½ï¼‰ï¼ˆå®šæ—¶å™¨æ—¶é—´åˆ°è¾¾ï¼‰è¿‡åè¿è¡Œè„šæœ¬ã€‚

æ‰§è¡Œè®¡æ—¶å™¨çš„é¡ºåºå°†æ ¹æ®è°ƒç”¨å®ƒä»¬çš„ä¸Šä¸‹æ–‡è€Œå¼‚ã€‚

**å¦‚æœäºŒè€…éƒ½ä»ä¸»æ¨¡å—å†…è°ƒç”¨ï¼Œåˆ™è®¡æ—¶å™¨å°†å—è¿›ç¨‹æ€§èƒ½çš„çº¦æŸï¼ˆè¿™å¯èƒ½ä¼šå—åˆ°è®¡ç®—æœºä¸Šå…¶ä»–æ­£åœ¨è¿è¡Œåº”ç”¨ç¨‹åºçš„å½±å“ï¼‰ã€‚**

ä¾‹å¦‚ï¼Œå¦‚æœè¿è¡Œä»¥ä¸‹ä¸åœ¨ `I/O` å‘¨æœŸï¼ˆå³ä¸»æ¨¡å—ï¼‰å†…çš„è„šæœ¬ï¼Œåˆ™æ‰§è¡Œä¸¤ä¸ªè®¡æ—¶å™¨çš„é¡ºåºæ˜¯éç¡®å®šæ€§çš„ï¼Œå› ä¸ºå®ƒå—è¿›ç¨‹æ€§èƒ½çš„çº¦æŸï¼š

```js
setTimeout(() => {
  console.log('timeout')
}, 0)

setImmediate(() => {
  console.log('immediate')
})
```

```lua
$ node timeout_vs_immediate.js
timeout
immediate

$ node timeout_vs_immediate.js
immediate
timeout
```

**<font color="#FF4444">ä½†æ˜¯ï¼Œå¦‚æœä½ æŠŠè¿™ä¸¤ä¸ªå‡½æ•°æ”¾å…¥ä¸€ä¸ª `I/O` å¾ªç¯å†…è°ƒç”¨ï¼Œ`setImmediate` æ€»æ˜¯è¢«ä¼˜å…ˆè°ƒç”¨ï¼šå› ä¸º `I/O` æ“ä½œæ˜¯åœ¨ `poll` é˜¶æ®µè¿›è¡Œçš„ï¼Œ`poll` é˜¶æ®µä¹‹åæ˜¯ `check`ï¼ˆä¹Ÿå°±æ˜¯è°ƒç”¨ `setImmediate`ï¼‰ã€‚</font>**

```js
const fs = require('fs')
// I/O  è½®è¯¢æ—¶ä¼šæ‰§è¡Œi/oå›è°ƒ å¦‚æœæ²¡æœ‰å®šä¹‰setImmediateä¼šç­‰å¾…å‰©ä¸‹çš„i/oå®Œæˆ æˆ–è€…å®šæ—¶å™¨åˆ°è¾¾æ—¶é—´
fs.readFile(__filename, () => {
  setTimeout(() => {
    console.log('timeout')
  }, 0)
  setImmediate(() => {
    // ä¸æ˜¯ç‰¹åˆ«é‡è¦çš„ä»»åŠ¡ å¯ä»¥æ”¾åˆ°setImmediate
    console.log('immediate')
  })
})
```

```lua
$ node timeout_vs_immediate.js
immediate
timeout

$ node timeout_vs_immediate.js
immediate
timeout
```

**ä½¿ç”¨ Â `setImmediate()`Â  ç›¸å¯¹äº `setTimeout()`Â  çš„ä¸»è¦ä¼˜åŠ¿æ˜¯ï¼Œå¦‚æœ `setImmediate()`æ˜¯åœ¨ `I/O` å‘¨æœŸå†…è¢«è°ƒåº¦çš„ï¼Œé‚£å®ƒå°†ä¼šåœ¨å…¶ä¸­ä»»ä½•çš„å®šæ—¶å™¨ä¹‹å‰æ‰§è¡Œï¼Œè·Ÿè¿™é‡Œå­˜åœ¨å¤šå°‘ä¸ªå®šæ—¶å™¨æ— å…³ã€‚**

## `close callbacks`

å¦‚æœå¥—æ¥å­—æˆ–å¥æŸ„çªç„¶å…³é—­(ä¾‹å¦‚ `socket.destroy()`)ï¼Œé‚£ä¹ˆ`â€™closeâ€™`äº‹ä»¶å°†åœ¨è¿™ä¸ªé˜¶æ®µå‘å‡ºã€‚å¦åˆ™ï¼Œå®ƒå°†é€šè¿‡ `process.nextTick()`å‘å‡ºã€‚

`process.nextTick()`æ–¹æ³•å°† `callback` æ·»åŠ åˆ° `next tick` é˜Ÿåˆ—ã€‚ ä¸€æ—¦å½“å‰äº‹ä»¶è½®è¯¢é˜Ÿåˆ—çš„ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼Œåœ¨ `next tick` é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ `callbacks` ä¼šè¢«ä¾æ¬¡è°ƒç”¨ã€‚å³ï¼Œå½“æ¯ä¸ªé˜¶æ®µå®Œæˆåï¼Œå¦‚æœå­˜åœ¨ `nextTick` é˜Ÿåˆ—ï¼Œå°±ä¼šæ¸…ç©ºé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”ä¼˜å…ˆäºå…¶ä»– `microtask` æ‰§è¡Œã€‚

`Nodejs` ä¸æµè§ˆå™¨çš„ `Event Loop` å·®å¼‚ï¼š

- `Node` ç«¯ï¼Œ`microtaskï¼ˆå¾®ä»»åŠ¡ï¼‰` åœ¨äº‹ä»¶å¾ªç¯çš„å„ä¸ªé˜¶æ®µä¹‹é—´æ‰§è¡Œã€‚
- æµè§ˆå™¨ç«¯ï¼Œ`microtaskï¼ˆå¾®ä»»åŠ¡ï¼‰` åœ¨äº‹ä»¶å¾ªç¯çš„ `macrotaskï¼ˆå®ä»»åŠ¡ï¼‰`æ‰§è¡Œå®Œä¹‹åæ‰§è¡Œã€‚

![diff](https://steinsgate.oss-cn-hangzhou.aliyuncs.com/diff.png)
