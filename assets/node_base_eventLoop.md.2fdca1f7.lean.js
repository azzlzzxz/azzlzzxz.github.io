import{_ as c,B as t,o as r,c as i,N as l,D as p,z as o,x as s,a as n}from"./chunks/framework.2673bc46.js";const A=JSON.parse('{"title":"Node 的事件循环机制","description":"","frontmatter":{},"headers":[],"relativePath":"node/base/eventLoop.md","lastUpdated":1727602247000}'),d={name:"node/base/eventLoop.md"};function y(F,a,D,m,b,u){const e=t("font");return r(),i("div",null,[a[2]||(a[2]=l(`<h1 id="node-的事件循环机制" tabindex="-1">Node 的事件循环机制 <a class="header-anchor" href="#node-的事件循环机制" aria-label="Permalink to &quot;Node 的事件循环机制&quot;">​</a></h1><p><img src="https://steinsgate.oss-cn-hangzhou.aliyuncs.com/Node_EventLoop.jpg" alt="node_eventLoop"></p><h2 id="event-loop-是一个独立的线程" tabindex="-1"><code>event loop</code> 是一个独立的线程 <a class="header-anchor" href="#event-loop-是一个独立的线程" aria-label="Permalink to &quot;\`event loop\` 是一个独立的线程&quot;">​</a></h2><p>当 <code>Node.js</code> 启动时，它初始化事件循环，处理提供的输入脚本，这些脚本可能进行异步 <code>API</code> 调用、调度计时器或调用 <code>process.nextTick()</code>，然后开始处理事件循环。</p><div class="language-lua line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">   ┌───────────────────────┐</span></span>
<span class="line"><span style="color:#BABED8;">┌─</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;">│        timers         │</span></span>
<span class="line"><span style="color:#BABED8;">│  └──────────┬────────────┘</span></span>
<span class="line"><span style="color:#BABED8;">│  ┌──────────┴────────────┐</span></span>
<span class="line"><span style="color:#BABED8;">│  │     pending callbacks │</span></span>
<span class="line"><span style="color:#BABED8;">│  └──────────┬────────────┘</span></span>
<span class="line"><span style="color:#BABED8;">│  ┌──────────┴────────────┐</span></span>
<span class="line"><span style="color:#BABED8;">│  │     idle, prepare     │</span></span>
<span class="line"><span style="color:#BABED8;">│  └──────────┬────────────┘      ┌───────────────┐</span></span>
<span class="line"><span style="color:#BABED8;">│  ┌──────────┴────────────┐      │   </span><span style="color:#FFCB6B;">incoming</span><span style="color:#BABED8;">:   │</span></span>
<span class="line"><span style="color:#BABED8;">│  │         poll          │</span><span style="color:#89DDFF;">&lt;</span><span style="color:#BABED8;">─────┤  connections, │</span></span>
<span class="line"><span style="color:#BABED8;">│  └──────────┬────────────┘      │   data, etc.  │</span></span>
<span class="line"><span style="color:#BABED8;">│  ┌──────────┴────────────┐      └───────────────┘</span></span>
<span class="line"><span style="color:#BABED8;">│  │        check          │</span></span>
<span class="line"><span style="color:#BABED8;">│  └──────────┬────────────┘</span></span>
<span class="line"><span style="color:#BABED8;">│  ┌──────────┴────────────┐</span></span>
<span class="line"><span style="color:#BABED8;">└──┤    close callbacks    │</span></span>
<span class="line"><span style="color:#BABED8;">   └───────────────────────┘</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div>`,5)),p(e,{color:"#5887ff"},{default:o(()=>a[0]||(a[0]=[s("ul",null,[s("li",null,[s("code",null,"timers:"),n(" 执行 "),s("code",null,"setTimeout"),n(" 和 "),s("code",null,"setInterval"),n(" 中到期的 "),s("code",null,"callback"),n("。")]),s("li",null,[s("code",null,"pending callback:"),n(" 上一轮循环中少数的 "),s("code",null,"callback"),n(" 会放在这一阶段执行。")]),s("li",null,[s("code",null,"idle, prepare:"),n(" 仅在内部使用。")]),s("li",null,[s("code",null,"poll:"),n(" 最重要的阶段，执行 "),s("code",null,"pending"),n(),s("code",null,"callback"),n("，在适当的情况下会阻塞在这个阶段。")]),s("li",null,[s("code",null,"check:"),n(" 执行 "),s("code",null,"setImmediate"),n(" 的 "),s("code",null,"callback"),n("。")]),s("li",null,[s("code",null,"close callbacks:"),n(" 执行 close 事件的 "),s("code",null,"callback"),n("，例如 "),s("code",null,"socket.on(‘close’[,fn])"),n("或者 "),s("code",null,"http.server.on('close, fn)"),n("。")])],-1)])),_:1}),a[3]||(a[3]=l(`<blockquote><p><code>setImmediate()</code>是将事件插入到事件队列尾部，主线程和事件队列的函数执行完成之后立即执行 <code>setImmediate</code> 指定的回调函数</p></blockquote><p><code>event loop</code> 的每一次循环都需要依次经过上述的阶段。</p><p>每个阶段都有自己的 <code>FIFO</code> 的 <code>callback</code> 队列（在 <code>timer</code> 阶段其实使用一个最小堆而不是队列来保存所有元素，比如 <code>timeout</code> 的 <code>callback</code> 是按照超时时间的顺序来调用的，并不是先进先出的队列逻辑），每当进入某个阶段，都会从所属的队列中取出 <code>callback</code> 来执行。</p><p>当队列为空或者被执行 <code>callback</code> 的数量达到系统的最大数量时，进入下一阶段。这六个阶段都执行完毕称为一轮循环。</p><h2 id="timers" tabindex="-1"><code>timers</code> <a class="header-anchor" href="#timers" aria-label="Permalink to &quot;\`timers\`&quot;">​</a></h2><blockquote><p>源码地址 <a href="https://github.com/nodejs/node/blob/23a3410f9fecf2c8652eef4f92b4072edf307137/deps/uv/src/timer.c#L163" target="_blank" rel="noreferrer">uv__run_timers</a></p></blockquote><p>在 <code>timers</code> 阶段，会执行 <code>setTimeout</code> 和 <code>setInterval</code> 中到期的 <code>callback</code>。执行这两者回调需要设置一个毫秒数，理论上来说，应该是时间一到就立即执行 <code>callback</code> 回调，但是由于 <code>system</code> 的调度可能会延时，达不到预期时间。如下例：</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> fs </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">require</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">fs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">someAsyncOperation</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">callback</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFile</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/path/to/file</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">callback</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> timeoutScheduled </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> Date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#BABED8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">setTimeout</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">delay</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">Date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">timeoutScheduled</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">\`\${</span><span style="color:#BABED8;">delay</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">ms have passed since I was scheduled</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">100</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">someAsyncOperation</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">startCallback</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">Date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#F07178;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">Date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">startCallback</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">10</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// do nothing</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>当进入事件循环时，它有一个空队列（<code>fs.readFile()</code>尚未完成），因此定时器将等待剩余毫秒数，当到达 <code>95ms</code>（假设 <code>fs.readFile()</code>需要 <code>95ms</code>）时，<code>fs.readFile()</code>完成读取文件并且其完成需要 <code>10ms</code> 的回调被添加到轮询队列并执行。</p><p>因此，原本设置 <code>100ms</code> 后执行的回调函数，会在约 <code>105ms</code> 后执行。</p><h2 id="pending-callbacks" tabindex="-1"><code>pending callbacks</code> <a class="header-anchor" href="#pending-callbacks" aria-label="Permalink to &quot;\`pending callbacks\`&quot;">​</a></h2><p>此阶段执行某些系统操作（例如 <code>TCP</code> 错误类型）的回调。</p><p>例如：如果 <code>TCP socket ECONNREFUSED</code> 在尝试 <code>connect</code> 时 <code>receives</code>， 系统希望等待报告错误，这将在 <code>pending callbacks</code> 阶段执行。</p><h2 id="poll-轮询" tabindex="-1"><code>poll</code>（轮询） <a class="header-anchor" href="#poll-轮询" aria-label="Permalink to &quot;\`poll\`（轮询）&quot;">​</a></h2><p>执行 <code>pending callback</code>，在适当的情况下会阻塞在这个阶段。</p><p><code>poll</code> 里面 有很多回调 node 中有执行的最大个数，超过最大个数会被延迟到下一轮循环执行。</p><p><code>poll</code> 阶段有两个主要功能：</p><ol><li>执行 <code>I/O</code>（连接、数据进入/输出）回调。</li><li>处理轮询队列中的事件。</li></ol><p>当事件循环进入 <code>poll</code> 阶段并且在 <code>timers</code> 中没有可以执行定时器时：</p><ul><li><p>如果 <code>poll</code> 队列不为空，则事件循环将遍历其同步执行它们的 <code>callback</code> 队列，直到队列为空，或者达到 system-dependent（系统相关限制）。</p></li><li><p>如果 <code>poll</code> 队列为空，会检查是否有 <code>setImmediate()</code>回调需要执行，如果有则马上进入执行 <code>check</code> 阶段以执行回调。</p></li><li><p>如果 <code>timers</code> 中有可以执行定时器且 <code>poll</code> 队列为空时，则会判断是否有 <code>timer</code> 超时，如果有的话会回到 <code>timer</code> 阶段执行回调。</p></li></ul><h2 id="check" tabindex="-1"><code>check</code> <a class="header-anchor" href="#check" aria-label="Permalink to &quot;\`check\`&quot;">​</a></h2><p>此阶段执行 <code>setImmediate</code> 的 <code>callback</code>。</p><p><code>setImmediate()</code>实际上是一个特殊的计时器，它在事件循环的一个单独阶段运行。它使用一个 <code>libuv API</code>，该 <code>API</code> 在 <code>poll</code> 阶段完成后执行 <code>callback</code>。</p><ul><li><p><code>setImmediate()</code>和 <code>setTimeout()</code>是相似的，但根据它们被调用的时间以不同的方式表现。</p></li><li><p><code>setImmediate()</code>设计用于在当前 <code>poll</code> 阶段完成后 <code>check</code> 阶段执行脚本 。</p></li><li><p><code>setTimeout()</code> 安排在经过<code>最小（ms）</code>后运行的脚本，在 <code>timers</code> 阶段执行。</p></li></ul><p>举个 🌰：</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> fs </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">require</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">fs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFile</span><span style="color:#BABED8;">(__filename</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">setTimeout</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">timeout</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">},</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">setImmediate</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">immediate</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-lua line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">immediate</span></span>
<span class="line"><span style="color:#BABED8;">timeout</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>主要原因是在 <code>I/O</code> 阶段读取文件后，事件循环会先进入 <code>poll</code> 阶段，发现有 <code>setImmediate</code> 需要执行，会立即进入 check 阶段执行 <code>setImmediate</code> 的回调。然后再进入 timers 阶段，执行 <code>setTimeout</code>，打印 <code>timeout</code>。</p><h3 id="setimmediate-与-settimeout-的区别" tabindex="-1"><code>setImmediate</code> 与 <code>setTimeout</code> 的区别 <a class="header-anchor" href="#setimmediate-与-settimeout-的区别" aria-label="Permalink to &quot;\`setImmediate\` 与 \`setTimeout\` 的区别&quot;">​</a></h3><p><code>setImmediate()</code>  和  <code>setTimeout()</code>  很类似，但是基于被调用的时机，他们也有不同表现。</p><ol><li><code>setImmediate()</code>  设计为一旦在当前   轮询   阶段完成， 就执行脚本。</li><li><code>setTimeout()</code>  在最小阈值（ms 单位）（定时器时间到达）过后运行脚本。</li></ol><p>执行计时器的顺序将根据调用它们的上下文而异。</p><p><strong>如果二者都从主模块内调用，则计时器将受进程性能的约束（这可能会受到计算机上其他正在运行应用程序的影响）。</strong></p><p>例如，如果运行以下不在 <code>I/O</code> 周期（即主模块）内的脚本，则执行两个计时器的顺序是非确定性的，因为它受进程性能的约束：</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#82AAFF;">setTimeout</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">timeout</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">0</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">setImmediate</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">immediate</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-lua line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">$ node timeout_vs_immediate.</span><span style="color:#FFCB6B;">js</span></span>
<span class="line"><span style="color:#BABED8;">timeout</span></span>
<span class="line"><span style="color:#BABED8;">immediate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">$ node timeout_vs_immediate.</span><span style="color:#FFCB6B;">js</span></span>
<span class="line"><span style="color:#BABED8;">immediate</span></span>
<span class="line"><span style="color:#BABED8;">timeout</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div>`,36)),s("p",null,[s("strong",null,[p(e,{color:"#FF4444"},{default:o(()=>a[1]||(a[1]=[n("但是，如果你把这两个函数放入一个 "),s("code",null,"I/O",-1),n(" 循环内调用，"),s("code",null,"setImmediate",-1),n(" 总是被优先调用：因为 "),s("code",null,"I/O",-1),n(" 操作是在 "),s("code",null,"poll",-1),n(" 阶段进行的，"),s("code",null,"poll",-1),n(" 阶段之后是 "),s("code",null,"check",-1),n("（也就是调用 "),s("code",null,"setImmediate",-1),n("）。")])),_:1})])]),a[4]||(a[4]=l(`<div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> fs </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">require</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">fs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// I/O  轮询时会执行i/o回调 如果没有定义setImmediate会等待剩下的i/o完成 或者定时器到达时间</span></span>
<span class="line"><span style="color:#BABED8;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFile</span><span style="color:#BABED8;">(__filename</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">setTimeout</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">timeout</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">},</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">setImmediate</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 不是特别重要的任务 可以放到setImmediate</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">immediate</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-lua line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">$ node timeout_vs_immediate.</span><span style="color:#FFCB6B;">js</span></span>
<span class="line"><span style="color:#BABED8;">immediate</span></span>
<span class="line"><span style="color:#BABED8;">timeout</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">$ node timeout_vs_immediate.</span><span style="color:#FFCB6B;">js</span></span>
<span class="line"><span style="color:#BABED8;">immediate</span></span>
<span class="line"><span style="color:#BABED8;">timeout</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>使用  <code>setImmediate()</code>  相对于 <code>setTimeout()</code>  的主要优势是，如果 <code>setImmediate()</code>是在 <code>I/O</code> 周期内被调度的，那它将会在其中任何的定时器之前执行，跟这里存在多少个定时器无关。</strong></p><h2 id="close-callbacks" tabindex="-1"><code>close callbacks</code> <a class="header-anchor" href="#close-callbacks" aria-label="Permalink to &quot;\`close callbacks\`&quot;">​</a></h2><p>如果套接字或句柄突然关闭(例如 <code>socket.destroy()</code>)，那么<code>’close’</code>事件将在这个阶段发出。否则，它将通过 <code>process.nextTick()</code>发出。</p><p><code>process.nextTick()</code>方法将 <code>callback</code> 添加到 <code>next tick</code> 队列。 一旦当前事件轮询队列的任务全部完成，在 <code>next tick</code> 队列中的所有 <code>callbacks</code> 会被依次调用。即，当每个阶段完成后，如果存在 <code>nextTick</code> 队列，就会清空队列中的所有回调函数，并且优先于其他 <code>microtask</code> 执行。</p><p><code>Nodejs</code> 与浏览器的 <code>Event Loop</code> 差异：</p><ul><li><code>Node</code> 端，<code>microtask（微任务）</code> 在事件循环的各个阶段之间执行。</li><li>浏览器端，<code>microtask（微任务）</code> 在事件循环的 <code>macrotask（宏任务）</code>执行完之后执行。</li></ul><p><img src="https://steinsgate.oss-cn-hangzhou.aliyuncs.com/diff.png" alt="diff"></p>`,9))])}const E=c(d,[["render",y]]);export{A as __pageData,E as default};
