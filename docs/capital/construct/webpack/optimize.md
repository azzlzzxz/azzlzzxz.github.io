# Webpack ä¼˜åŒ–ç›¸å…³çŸ¥è¯†

## å‹ç¼©èµ„æº

- `JavaScriptå‹ç¼©`ï¼šä½¿ç”¨ [<u>TerserWebpackPlugin</u>](https://webpack.docschina.org/plugins/terser-webpack-plugin/) ç­‰å·¥å…·å‹ç¼© JS ä»£ç ã€‚

- `CSSå‹ç¼©`ï¼šä½¿ç”¨ [<u>cssnano</u>](https://www.npmjs.com/package/cssnano) ç­‰å·¥å…·å‹ç¼© CSS ä»£ç ã€‚

- `HTMLå‹ç¼©`ï¼šä½¿ç”¨ [<u>HtmlWebpackPlugin</u>](https://webpack.docschina.org/plugins/html-webpack-plugin/) æ—¶é…ç½®å‹ç¼©é€‰é¡¹ã€‚

- `å›¾ç‰‡å‹ç¼©`ï¼šä½¿ç”¨ [<u>image-webpack-loader</u>](https://www.npmjs.com/package/image-webpack-loader) ç­‰å·¥å…·å‡å°å›¾ç‰‡ä½“ç§¯ã€‚

## å¼•å…¥å¤–éƒ¨åº“çš„ CDN

å¯¹äº Reactã€Vue ç­‰è¿™ç§åº“ä¸ä¼šç»å¸¸å˜åŒ–ï¼Œæ‰€ä»¥å°±æ²¡å¿…è¦æ‰“åŒ…ã€‚è¿™ç§æ–¹å¼å¯ä»¥å‡å°‘æ‰“åŒ…ä½“ç§¯ï¼Œå¹¶åˆ©ç”¨ CDN çš„ç¼“å­˜ä¼˜åŠ¿åŠ å¿«é¡µé¢åŠ è½½é€Ÿåº¦

> ä¸¾ä¸ª ğŸŒ°

```js
const path = require('path')
const HtmlWebpackPlugin = require('html-webpack-plugin')

module.exports = {
  entry: './src/index.js',
  output: {
    filename: 'bundle.js',
    path: path.resolve(__dirname, 'dist'),
  },
  // é…ç½® externalsï¼Œè¯´æ˜å“ªäº›æ¨¡å—æ˜¯å¤–éƒ¨å¼•å…¥çš„ï¼Œä¸æ‰“åŒ…åˆ° bundle ä¸­
  externals: {
    react: 'React',
    'react-dom': 'ReactDOM',
    vue: 'Vue',
  },
}
```

## å¿½ç•¥è§£æä¾èµ–

- `module.noParse`Â  å­—æ®µï¼Œå¯ä»¥ç”¨äºé…ç½®æ¨¡å—æ–‡ä»¶çš„å†…å®¹ä¸éœ€è¦è¿›è¡Œè§£æ

- ä¸éœ€è¦è§£æä¾èµ–ï¼ˆå³æ— ä¾èµ–ï¼‰ çš„ç¬¬ä¸‰æ–¹å¤§å‹ç±»åº“ç­‰ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªå­—æ®µæ¥é…ç½®ï¼Œä»¥æé«˜æ•´ä½“çš„æ„å»ºé€Ÿåº¦

> ä¸¾ä¸ª ğŸŒ°

```js
module.exports = {
  // ...
  module: {
    // ä¸éœ€è¦è§£æjqueryå’Œlodash
    noParse: /jquery|lodash/, // æ­£åˆ™è¡¨è¾¾å¼
    // æˆ–è€…ä½¿ç”¨å‡½æ•°
    noParse(content) {
      return /jquery|lodash/.test(content)
    },
  },
}
```

**ä½¿ç”¨ `noParse` è¿›è¡Œå¿½ç•¥çš„æ¨¡å—æ–‡ä»¶ä¸­ä¸èƒ½ä½¿ç”¨ `import`ã€`require`ã€`define` ç­‰å¯¼å…¥æœºåˆ¶ã€‚**

::: tip `noParse`ä¸`external`åŒºåˆ«

- `external`æ˜¯å¤–è”ï¼šä¾‹å¦‚`lodash`ï¼Œå®ƒçš„ä»£ç `module.exports = window._`ï¼Œæ‹¿åˆ°è¿™ä¸ªä»£ç ä¼šè¿›ä¸€æ­¥åˆ†æä¾èµ–ï¼Œæ‰¾`require`ã€`import`ã€‚
- `noParse`æ˜¯ä¸ä¼šè¿›ä¸€æ­¥åˆ†æä¾èµ–ï¼šä»£ç è¿˜æ˜¯ä¼šæ­£å¸¸æ‰“åŒ…è¿›å»ï¼Œä½†æ˜¯ä¸å†è¿›ä¸€æ­¥åˆ†æå®ƒçš„ä¾èµ–ï¼Œä¸å†æ£€æŸ¥é‡Œé¢æ˜¯ä¸æ˜¯æœ‰`require`ã€`important`ã€‚

:::

## ä»£ç åˆ†å‰² `SplitChunksPlugin`

- ç”¨ `SplitChunksPlugin` è‡ªåŠ¨æå–å…¬å…±æ¨¡å—å’Œç¬¬ä¸‰æ–¹åº“ï¼Œå¯ä»¥å‡å°‘ä»£ç é‡å¤å’Œå‡å°‘ç¼–è¯‘æ—¶é—´ã€‚

- æå–å…¬å…±æ¨¡å—ï¼šå°†å¤šä¸ª `chunk` å…±äº«çš„æ¨¡å—æå–åˆ°ä¸€ä¸ªå•ç‹¬ `chunk` ä¸­ï¼Œå‡å°‘ä»£ç é‡å¤å’Œç”Ÿæˆæ–‡ä»¶çš„å¤§å°ã€‚

- åˆ†å‰²å¤§æ¨¡å—ï¼šå°†å¤§çš„æ¨¡å—æ‹†åˆ†æˆæ›´å°çš„å—ï¼Œæé«˜åŠ è½½é€Ÿåº¦å’Œå¹¶è¡Œä¸‹è½½çš„æ•ˆç‡ã€‚

- æŒ‰éœ€åŠ è½½ï¼šåˆ›å»ºæŒ‰éœ€åŠ è½½çš„ä»£ç å—ï¼Œæé«˜åº”ç”¨çš„å¯åŠ¨é€Ÿåº¦

> ä¾èµ–å…³ç³»

![webpack_split](../images/webpack_split.png)

## å¤šè¿›ç¨‹æ‰“åŒ…

ä½¿ç”¨ [<u>thread-loader</u>](https://webpack.docschina.org/loaders/thread-loader/#root) å¯ä»¥å°†æ‰“åŒ…ä»»åŠ¡åˆ†é…åˆ°å¤šä¸ªè¿›ç¨‹ï¼Œæé«˜æ‰“åŒ…é€Ÿåº¦

æŠŠ`thread-loader`æ”¾åœ¨å…¶ä»–`loader`ä¹‹å‰ï¼Œæ”¾åœ¨è¿™ä¸ª`loader`åçš„`loader`å°±ä¼šåœ¨å•ç‹¬çš„`worker`æ± é‡Œè¿è¡Œ

## ç¼“å­˜

- `Webpack 4`

  - `babel-loader`è‡ªå¸¦çš„ç¼“å­˜åŠŸèƒ½ï¼Œç›´æ¥å¯ç”¨å°±å¥½ï¼Œ`cacheDirectory:true`

  - åœ¨æ‰€æœ‰`loader`ä¹‹å‰ä½¿ç”¨`loader: 'cache-loader'`

```js
module.exports = {
  // ...
  module: {
    rules: [
      {
        test: /\.js$/,
        include: path.resolve(__dirname, 'src'),
        exclude: /node_modules/,
        use: [
          {
            loader: 'cache-loader',
          },
          {
            loader: 'babel-loader',
            options: {
              cacheDirectory: true, //å¯ç”¨ç¼“å­˜
              presets: [['@babel/preset-env', { modules: false }], '@babel/preset-react'],
            },
          },
        ],
      },
    ],
  },
}
```

- `Webpack 5` å¼•å…¥äº†æŒä¹…åŒ–ç¼“å­˜ï¼Œé€šè¿‡é…ç½®`cache.type`å±æ€§ç¼“å­˜ç”Ÿæˆçš„ `chunk`

  - `webpack`ä¼šç¼“å­˜ç”Ÿæˆçš„`webpack`æ¨¡å—å’Œ`chunk`ï¼Œæ¥æ”¹å–„æ„å»ºé€Ÿåº¦ã€‚

  - ç¼“å­˜åœ¨`webpack5`é‡Œæ˜¯é»˜è®¤å¼€å¯çš„ï¼Œç¼“å­˜æ˜¯é»˜è®¤æ˜¯åœ¨å†…å­˜é‡Œï¼Œä½†å¯ä»¥å¯¹`cache`è¿›è¡Œè®¾ç½®ã€‚

  - `webpack`è¿½è¸ªäº†æ¯ä¸ªæ¨¡å—çš„ä¾èµ–ï¼Œå¹¶åˆ›å»ºäº†æ–‡ä»¶ç³»ç»Ÿå¿«ç…§ï¼Œæ­¤å¿«ç…§ä¼šä¸çœŸå®æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ¯”è¾ƒï¼Œå½“æ£€æµ‹åˆ°å·®å¼‚æ—¶ï¼Œå°†è§¦å‘å¯¹åº”æ¨¡å—çš„æ›´æ–°æ„å»º

```js
cache: {
  type: 'memory',  //'memory'ï¼ˆå†…å­˜ï¼‰ | 'filesystem'ï¼ˆä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿçº§åˆ«çš„ç¼“å­˜ï¼‰
}
```

## `Tree shaking`

`Tree Shaking` æ˜¯ä¸€ç§ç”¨äºç§»é™¤ `JavaScript` ä¸­æœªä½¿ç”¨ä»£ç çš„ä¼˜åŒ–æŠ€æœ¯ã€‚å¯ä»¥å‡å°æ‰“åŒ…æ–‡ä»¶çš„ä½“ç§¯ï¼Œæé«˜åŠ è½½æ€§èƒ½ã€‚

å®ƒä¾èµ–äº `ES6` æ¨¡å—çš„é™æ€ç»“æ„ç‰¹æ€§ï¼ˆ`import` å’Œ `export`ï¼‰ï¼Œä½¿å¾—æ„å»ºå·¥å…·èƒ½å¤Ÿåœ¨ç¼–è¯‘æ—¶ç¡®å®šå“ªäº›ä»£ç æ˜¯æœªä½¿ç”¨çš„ï¼Œå¹¶å°†å…¶ç§»é™¤ã€‚

### å¯åŠ¨ `Tree Shaking`

åœ¨ `Webpack` ä¸­ï¼Œå¯åŠ¨ `Tree Shaking` åŠŸèƒ½å¿…é¡»åŒæ—¶æ»¡è¶³ä¸‰ä¸ªæ¡ä»¶ï¼š

- ä½¿ç”¨ `ESM` è§„èŒƒç¼–å†™æ¨¡å—ä»£ç 

- é…ç½® `optimization.usedExports` ä¸º `true`ï¼Œå¯åŠ¨æ ‡è®°åŠŸèƒ½

- å¯åŠ¨ä»£ç ä¼˜åŒ–åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å®ç°ï¼š

  - é…ç½® `mode = production`

  - é…ç½® `optimization.minimize = true`

  - æä¾› `optimization.minimizer` æ•°ç»„

### å®ç°åŸç†

`Webpack` ä¸­ï¼Œ`Tree-shaking` çš„å®ç°ï¼Œä¸€æ˜¯å…ˆæ ‡è®°å‡ºæ¨¡å—å¯¼å‡ºå€¼ä¸­å“ªäº›æ²¡æœ‰è¢«ç”¨è¿‡ï¼ŒäºŒæ˜¯ä½¿ç”¨ `Terser` åˆ æ‰è¿™äº›æ²¡è¢«ç”¨åˆ°çš„å¯¼å‡ºè¯­å¥ã€‚æ ‡è®°è¿‡ç¨‹å¤§è‡´å¯åˆ’åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š

- `Make é˜¶æ®µ`ï¼šæ”¶é›†æ¨¡å—å¯¼å‡ºå˜é‡å¹¶è®°å½•åˆ°æ¨¡å—ä¾èµ–å…³ç³»å›¾ `ModuleGraph` å˜é‡ä¸­

- `Seal é˜¶æ®µ`ï¼šéå† `ModuleGraph` æ ‡è®°æ¨¡å—å¯¼å‡ºå˜é‡æœ‰æ²¡æœ‰è¢«ä½¿ç”¨

- `ç”Ÿæˆäº§ç‰©æ—¶`ï¼šè‹¥å˜é‡æ²¡æœ‰è¢«å…¶å®ƒæ¨¡å—ä½¿ç”¨åˆ™åˆ é™¤å¯¹åº”çš„å¯¼å‡ºè¯­å¥

::: info ç›¸å…³èµ„æ–™

- [<u>Tree-Shaking å®ç°åŸç†</u>](https://juejin.cn/post/7019104818568364069)

:::

## `HMR` çƒ­æ›´æ–°

`HMR` çƒ­æ›´æ–°ï¼Œå®ƒèƒ½å¤Ÿåœ¨ä¿æŒé¡µé¢çŠ¶æ€çš„æƒ…å†µä¸‹åŠ¨æ€æ›¿æ¢èµ„æºæ¨¡å—ï¼Œæä¾›ä¸æ»‘é¡ºç•…çš„ `Web` é¡µé¢å¼€å‘ä½“éªŒã€‚

### å¯åŠ¨ `HMR`

```js
module.exports = {
  // ...
  devServer: {
    hot: true,
  },
}
```

### `HMR` å®ç°åŸç†

- ä½¿ç”¨ `WDSï¼ˆwebpack-dev-serverï¼‰`æ‰˜ç®¡é™æ€èµ„æºï¼ŒåŒæ—¶ä»¥ `Runtime` æ–¹å¼æ³¨å…¥ `HMR` å®¢æˆ·ç«¯ä»£ç 

- æµè§ˆå™¨åŠ è½½é¡µé¢åï¼Œä¸ `WDS` å»ºç«‹ `WebSocket` è¿æ¥

- `Webpack` ç›‘å¬åˆ°æ–‡ä»¶å˜åŒ–åï¼Œå¢é‡æ„å»ºå‘ç”Ÿå˜æ›´çš„æ¨¡å—ï¼Œå¹¶é€šè¿‡ `WebSocket` å‘é€ `hash` äº‹ä»¶

- æµè§ˆå™¨æ¥æ”¶åˆ° `hash` äº‹ä»¶åï¼Œè¯·æ±‚ `manifest` èµ„æºæ–‡ä»¶ï¼Œç¡®è®¤å¢é‡å˜æ›´èŒƒå›´

- æµè§ˆå™¨åŠ è½½å‘ç”Ÿå˜æ›´çš„å¢é‡æ¨¡å—

- `Webpack` è¿è¡Œæ—¶è§¦å‘å˜æ›´æ¨¡å—çš„ `module.hot.accept` å›è°ƒï¼Œæ‰§è¡Œä»£ç å˜æ›´é€»è¾‘

> æµç¨‹å›¾

![webpack_hmr](../images/webpack_hmr.png)

::: info ç›¸å…³èµ„æ–™

- [<u>HMR åŸç†å…¨è§£æ</u>](https://juejin.cn/post/7021729340945596424)

:::

## `Mainfest` æ›´æ–°æ¸…å•

[<u>`mainfest`</u>](https://webpack.docschina.org/guides/output-management/#the-manifest)ï¼ˆæ›´æ–°æ¸…å•ï¼‰ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ª `JSON` æ–‡ä»¶ã€‚éœ€è¦é…ç½® [<u>WebpackManifestPlugin</u>](https://www.npmjs.com/package/webpack-manifest-plugin) æ’ä»¶ã€‚

åœ¨ `Webpack` è¾“å‡ºé˜¶æ®µç”Ÿæˆï¼Œç”¨äºè®°å½•æ‰€æœ‰æ¨¡å—åŠå…¶ä¾èµ–å…³ç³»çš„æ˜ å°„ç”¨æ¥ç®¡ç†æ¨¡å—åŠ è½½ã€ä¼˜åŒ–æµè§ˆå™¨ç¼“å­˜ã€‚ åŒ…å«ï¼š

- æ¨¡å—æ ‡è¯†ç¬¦ï¼š æ¯ä¸ªæ¨¡å—éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œè¿™äº›æ ‡è¯†ç¬¦ç”¨äºåœ¨è¿è¡Œæ—¶æŸ¥æ‰¾å’ŒåŠ è½½æ¨¡å—ã€‚

- `Chunk` æ˜ å°„å…³ç³»ï¼šåŒ…å« `chunk` ä¸åŒ…å«çš„æ¨¡å—ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œä»¥åŠ `chunk` ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚è¿™æœ‰åŠ©äºè¿è¡Œæ—¶ç¡®å®šå“ªäº› `chunk` éœ€è¦è¢«åŠ è½½ã€‚

- `Hash` å€¼ï¼š æ¯ä¸ªè¾“å‡ºæ–‡ä»¶çš„ `hash` å€¼ã€‚æœ‰åŠ©äºæµè§ˆå™¨åˆ¤æ–­æ–‡ä»¶æ˜¯å¦æœ‰æ›´æ–°ï¼Œä»è€Œå†³å®šæ˜¯åŠ è½½ç¼“å­˜ä¸­çš„èµ„æºè¿˜æ˜¯é‡æ–°è¯·æ±‚æ–°çš„èµ„æº

```json
{
  "main.js": "main.xxxxxx.js",
  "vendor.js": "vendor.xxxxxx.js"
}
```

`manifest` æ–‡ä»¶å¯ä»¥ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š

- æœåŠ¡ç«¯æ¸²æŸ“: åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `manifest` æ–‡ä»¶æ¥ç”Ÿæˆæ­£ç¡®çš„è„šæœ¬æ ‡ç­¾ï¼Œç¡®ä¿å¼•ç”¨æœ€æ–°çš„èµ„æºã€‚

- ç¼“å­˜ç®¡ç†: é€šè¿‡è®°å½•æ–‡ä»¶çš„å“ˆå¸Œå€¼ï¼Œç¡®ä¿åœ¨æ–‡ä»¶å†…å®¹å˜åŒ–æ—¶ï¼Œå®¢æˆ·ç«¯èƒ½å¤Ÿè·å–åˆ°æœ€æ–°çš„æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç¼“å­˜çš„æ—§æ–‡ä»¶ã€‚

- åŠ¨æ€åŠ è½½: åœ¨éœ€è¦æŒ‰éœ€åŠ è½½æ¨¡å—æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `manifest` æ–‡ä»¶æ¥æŸ¥æ‰¾æ¨¡å—çš„è·¯å¾„ã€‚
