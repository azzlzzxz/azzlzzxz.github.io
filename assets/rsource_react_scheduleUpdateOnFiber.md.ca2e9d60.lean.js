import{_ as n,o as a,c as l,N as p}from"./chunks/framework.2f525601.js";const D=JSON.parse('{"title":"scheduleUpdateOnFiber è°ƒåº¦æ›´æ–°","description":"","frontmatter":{},"headers":[],"relativePath":"rsource/react/scheduleUpdateOnFiber.md","lastUpdated":1730182680000}'),o={name:"rsource/react/scheduleUpdateOnFiber.md"};function e(r,s,c,t,i,y){return a(),l("div",null,s[0]||(s[0]=[p(`<h1 id="scheduleupdateonfiber-è°ƒåº¦æ›´æ–°" tabindex="-1">scheduleUpdateOnFiber è°ƒåº¦æ›´æ–° <a class="header-anchor" href="#scheduleupdateonfiber-è°ƒåº¦æ›´æ–°" aria-label="Permalink to &quot;scheduleUpdateOnFiber è°ƒåº¦æ›´æ–°&quot;">â€‹</a></h1><p>åœ¨ <code>updateContainer</code> ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª <code>update</code> å¯¹è±¡ï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°æ›´æ–°é˜Ÿåˆ—ä¸­ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨ <code>scheduleUpdateOnFiber</code> è¿›è¡Œæ›´æ–°ï¼ˆè¿™ä¹Ÿæ˜¯ <code>render</code> é˜¶æ®µçš„å…¥å£ï¼‰</p><blockquote><p>ä»è°ƒåº¦æ›´æ–° <code>scheduleUpdateOnFiber</code> åˆ° æäº¤æ›´æ–° <code>commitRoot</code> æµç¨‹å›¾</p></blockquote><p><img src="https://steinsgate.oss-cn-hangzhou.aliyuncs.com/react/scheduleUpdateOnFiber.jpg" alt="scheduleUpdateOnFiber"></p><hr><p>ä»£ç é‡Œå…³äº<code>lane(èµ›é“æ¨¡å‹)</code>çš„ï¼Œå¯ä»¥çœ‹è¿™é‡Œ <a href="/rsource/react/lane"><u>React | lane æ¨¡å‹ ğŸš€</u></a></p><hr><blockquote><p>å…¥å£ <code>ReactFiberReconciler.js</code></p></blockquote><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight has-highlighted-lines"><code><span class="line"><span style="color:#676E95;font-style:italic;">// åˆ›å»ºå®¹å™¨</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">createContainer</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">containerInfo</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createFiberRoot</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">containerInfo</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * æ›´æ–°å®¹å™¨ æŠŠè™šæ‹ŸDOMï¼Œelementè½¬æ¢æˆçœŸå®DOMæ’å…¥åˆ°containerå®¹å™¨ä¸­</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#89DDFF;font-style:italic;">{</span><span style="color:#FFCB6B;font-style:italic;">*</span><span style="color:#89DDFF;font-style:italic;">}</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#BABED8;font-style:italic;">element</span><span style="color:#676E95;font-style:italic;"> è™šæ‹ŸDOM</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#89DDFF;font-style:italic;">{</span><span style="color:#FFCB6B;font-style:italic;">*</span><span style="color:#89DDFF;font-style:italic;">}</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#BABED8;font-style:italic;">container</span><span style="color:#676E95;font-style:italic;"> å®¹å™¨ FiberRootNode</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">updateContainer</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">element</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">container</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// è·å–å½“å‰æ ¹fiber (HostRootFiber)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">container</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">current</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// è¯·æ±‚äº‹ä»¶å‘ç”Ÿæ—¶é—´</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">eventTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">requestEventTime</span><span style="color:#F07178;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// è¯·æ±‚ä¸€ä¸ªæ›´æ–°è½¦é“</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">lane</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">requestUpdateLane</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">current</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// åˆ›å»ºæ›´æ–°</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">update</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createUpdate</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">lane</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// payloadæ˜¯è¦æ›´æ–°çš„è™šæ‹ŸDOM</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">update</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">payload</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">element</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å°†updateï¼ˆæ›´æ–°å¯¹è±¡ï¼‰æ’å…¥åˆ°å½“å‰fiberçš„æ›´æ–°é˜Ÿåˆ—ä¸­ï¼Œè¿”å›æ ¹èŠ‚ç‚¹</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">root</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">enqueueUpdate</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">update</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">lane</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">scheduleUpdateOnFiber</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">lane</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h2 id="scheduleupdateonfiber-è°ƒåº¦æ›´æ–°-1" tabindex="-1"><code>scheduleUpdateOnFiber</code> è°ƒåº¦æ›´æ–° <a class="header-anchor" href="#scheduleupdateonfiber-è°ƒåº¦æ›´æ–°-1" aria-label="Permalink to &quot;\`scheduleUpdateOnFiber\` è°ƒåº¦æ›´æ–°&quot;">â€‹</a></h2><blockquote><p>æºç åœ°å€ <a href="https://github.com/azzlzzxz/react-source-code/blob/3d95c43b8967d4dda1ec9a22f0d9ea4999fee8b8/packages/react-reconciler/src/ReactFiberWorkLoop.js#L716" target="_blank" rel="noreferrer"><u>scheduleUpdateOnFiber ï½œ react-reconciler/src/ReactFiberWorkLoop.js</u></a></p></blockquote><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight has-highlighted-lines"><code><span class="line"><span style="color:#676E95;font-style:italic;">// ReactFiberWorkLoop.js</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// æ­£åœ¨è¿›è¡Œä¸­çš„ä»»åŠ¡</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> workInProgress </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// å½“å‰æ­£åœ¨è°ƒåº¦çš„è·ŸèŠ‚ç‚¹</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> workInProgressRoot </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// æ­¤æ ¹èŠ‚ç‚¹ä¸Šæœ‰æ²¡æœ‰useEffectçš„ç±»ä¼¼å‰¯ä½œç”¨</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> rootDoesHavePassiveEffect </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// å…·æœ‰useEffectå‰¯ä½œç”¨çš„è·ŸèŠ‚ç‚¹ï¼ˆFiberRootNodeï¼Œæ ¹fiber.stateNodeï¼‰</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> rootWithPendingPassiveEffects </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// å½“å‰æ­£åœ¨æŒ‡å®šçš„æ¸²æŸ“ä¼˜å…ˆçº§</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> workInProgressRootRenderLanes </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> NoLanes</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// ä¿å­˜å½“å‰çš„äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> currentEventTime </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> NoTimestamp</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line highlighted"><span style="color:#676E95;font-style:italic;"> * è®¡åˆ’æ›´æ–°root</span></span>
<span class="line highlighted"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#89DDFF;font-style:italic;">{</span><span style="color:#FFCB6B;font-style:italic;">*</span><span style="color:#89DDFF;font-style:italic;">}</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#BABED8;font-style:italic;">root</span></span>
<span class="line highlighted"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line highlighted"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">scheduleUpdateOnFiber</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">root</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">fiber</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">lane</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">eventTime</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ ‡è®°å½“å‰æ ¹èŠ‚ç‚¹ä¸Šç­‰å¾…æ›´æ–°çš„lane</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">markRootUpdated</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">lane</span><span style="color:#F07178;">)</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// ç¡®ä¿è°ƒåº¦æ‰§è¡Œrootä¸Šçš„æ›´æ–°</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">ensureRootIsScheduled</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">eventTime</span><span style="color:#F07178;">)</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="ensurerootisscheduledç”¨äºæ³¨å†Œè°ƒåº¦ä»»åŠ¡" tabindex="-1"><code>ensureRootIsScheduled</code>ç”¨äºæ³¨å†Œè°ƒåº¦ä»»åŠ¡ <a class="header-anchor" href="#ensurerootisscheduledç”¨äºæ³¨å†Œè°ƒåº¦ä»»åŠ¡" aria-label="Permalink to &quot;\`ensureRootIsScheduled\`ç”¨äºæ³¨å†Œè°ƒåº¦ä»»åŠ¡&quot;">â€‹</a></h2><p><code>ensureRootIsScheduled</code> å‡½æ•°ç”¨äºæ³¨å†Œè°ƒåº¦ä»»åŠ¡ï¼Œå…¶å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li><p>åˆ¤æ–­æ˜¯å¦éœ€è¦æ³¨å†Œæ–°çš„è°ƒåº¦ï¼ˆå¦‚æœæ— éœ€æ–°çš„è°ƒåº¦ï¼Œä¼šé€€å‡ºå‡½æ•°ï¼‰</p></li><li><p>æ³¨å†Œè°ƒåº¦ä»»åŠ¡ï¼ˆ<a href="/rsource/react/schedule"><u>å…³äº React çš„ ä»»åŠ¡è°ƒåº¦å¯ä»¥çœ‹è¿™é‡Œ ğŸš€</u></a>ï¼‰</p><ul><li><p>å°† <code>performSyncWorkOnRoot</code> æˆ– <code>performConcurrentWorkOnRoot</code> æ·»åŠ åˆ°è°ƒåº¦é˜Ÿåˆ—ï¼ˆ<code>scheduleCallback</code>ï¼‰ä¸­</p></li><li><p>ç­‰å¾…è°ƒåº¦ä¸­å¿ƒæ‰§è¡Œ <code>performSyncWorkOnRoot</code> æˆ– <code>performConcurrentWorkOnRoot</code></p></li></ul></li></ul><div class="tip custom-block"><p class="custom-block-title"><code>performSyncWorkOnRoot</code> å’Œ <code>performConcurrentWorkOnRoot</code></p><ul><li>åœ¨ <code>sync</code> åŒæ­¥æ¨¡å¼ä¸‹ä¼šæ‰§è¡Œ <code>performSyncWorkOnRoot</code></li><li>åœ¨ <code>concurrent</code> å¹¶å‘æ¨¡å¼ä¸‹ä¼šæ‰§è¡Œ <code>performConcurrentWorkOnRoot</code></li></ul><p>è¿™ä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æ‰§è¡Œ <code>render</code> é˜¶æ®µå’Œ <code>commit</code> é˜¶æ®µ</p><p>ä¹Ÿå°±æ˜¯æ ¹æ®<code>è™šæ‹ŸDOM</code>æ„å»º<code>fiberæ ‘</code>ï¼Œè¦åˆ›å»ºçœŸå®çš„<code>DOM</code>èŠ‚ç‚¹ï¼Œè¿˜éœ€è¦æŠŠçœŸå®çš„<code>DOM</code>èŠ‚ç‚¹æ’å…¥å®¹å™¨</p></div><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight has-highlighted-lines"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">ensureRootIsScheduled</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">root</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å…ˆè·å–å½“å‰æ ¹ä¸Šæ‰§è¡Œä»»åŠ¡</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">existingCallbackNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">callbackNode</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æŠŠæ‰€æœ‰é¥¿æ­»çš„èµ›é“æ ‡è®°ä¸ºè¿‡æœŸ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">markStarvedLanesAsExpired</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">currentTime</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//è·å–å½“å‰ä¼˜å…ˆçº§æœ€é«˜çš„è½¦é“</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">nextLanes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">getNextLanes</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">workInProgressRootRenderLanes</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//å¦‚æœæ²¡æœ‰è¦æ‰§è¡Œçš„ä»»åŠ¡</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">nextLanes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">NoLanes</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">callbackNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">callbackPriority</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">NoLane</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// è·å–æ–°çš„è°ƒåº¦ä¼˜å…ˆçº§</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">newCallbackPriority</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">getHighestPriorityLane</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">nextLanes</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//è·å–ç°åœ¨æ ¹ä¸Šæ­£åœ¨è¿è¡Œçš„ä¼˜å…ˆçº§</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">existingCallbackPriority</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">callbackPriority</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//å¦‚æœæ–°çš„ä¼˜å…ˆçº§å’Œè€çš„ä¼˜å…ˆçº§ä¸€æ ·ï¼Œåˆ™å¯ä»¥è¿›è¡Œæ‰¹é‡æ›´æ–°</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">existingCallbackPriority</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">newCallbackPriority</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">existingCallbackNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">cancelCallback</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">Scheduler_cancelCallback</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">existingCallbackNode</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ–°çš„å›è°ƒä»»åŠ¡</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">newCallbackNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å¦‚æœæ–°çš„ä¼˜å…ˆçº§æ˜¯åŒæ­¥çš„è¯</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">newCallbackPriority</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">SyncLane</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//å…ˆæŠŠperformSyncWorkOnRootæ·»å›åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">scheduleSyncCallback</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">performSyncWorkOnRoot</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bind</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">null,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">root</span><span style="color:#F07178;">))</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//å†æŠŠflushSyncCallbacksæ”¾å…¥å¾®ä»»åŠ¡</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">queueMicrotask</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">flushSyncCallbacks</span><span style="color:#F07178;">)</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//å¦‚æœæ˜¯åŒæ­¥æ‰§è¡Œçš„è¯</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#BABED8;">newCallbackNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//å¦‚æœä¸æ˜¯åŒæ­¥ï¼Œå°±éœ€è¦è°ƒåº¦ä¸€ä¸ªæ–°çš„ä»»åŠ¡</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">schedulerPriorityLevel</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// lanesToEventPriority æ–¹æ³• æ˜¯æŠŠèµ›é“ä¼˜å…ˆçº§è½¬æˆäº‹ä»¶ä¼˜å…ˆçº§</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">switch</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">lanesToEventPriority</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">nextLanes</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line highlighted"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">DiscreteEventPriority</span><span style="color:#89DDFF;">:</span></span>
<span class="line highlighted"><span style="color:#F07178;">        </span><span style="color:#BABED8;">schedulerPriorityLevel</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">ImmediateSchedulerPriority</span></span>
<span class="line highlighted"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line highlighted"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">ContinuousEventPriority</span><span style="color:#89DDFF;">:</span></span>
<span class="line highlighted"><span style="color:#F07178;">        </span><span style="color:#BABED8;">schedulerPriorityLevel</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">UserBlockingSchedulerPriority</span></span>
<span class="line highlighted"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line highlighted"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">DefaultEventPriority</span><span style="color:#89DDFF;">:</span></span>
<span class="line highlighted"><span style="color:#F07178;">        </span><span style="color:#BABED8;">schedulerPriorityLevel</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">NormalSchedulerPriority</span></span>
<span class="line highlighted"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line highlighted"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">IdleEventPriority</span><span style="color:#89DDFF;">:</span></span>
<span class="line highlighted"><span style="color:#F07178;">        </span><span style="color:#BABED8;">schedulerPriorityLevel</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">IdleSchedulerPriority</span></span>
<span class="line highlighted"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line highlighted"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#89DDFF;">:</span></span>
<span class="line highlighted"><span style="color:#F07178;">        </span><span style="color:#BABED8;">schedulerPriorityLevel</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">NormalSchedulerPriority</span></span>
<span class="line highlighted"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å°† performConcurrentWorkOnRoot æ·»åŠ åˆ°è°ƒåº¦é˜Ÿåˆ—ä¸­</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">Scheduler_scheduleCallback</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">schedulerPriorityLevel</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">performConcurrentWorkOnRoot</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bind</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">null,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">root</span><span style="color:#F07178;">))</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// åœ¨æ ¹èŠ‚ç‚¹ä¸Šæ‰§è¡Œçš„ä»»åŠ¡æ˜¯newCallbackNode</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">callbackNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">newCallbackNode</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">callbackPriority</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">newCallbackPriority</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><blockquote><p>æ„å»º <code>Fiber Tree</code></p></blockquote><p><img src="https://steinsgate.oss-cn-hangzhou.aliyuncs.com/fiber_tree.jpg" alt="fiber_tree"></p><h2 id="syncåŒæ­¥æ¨¡å¼" tabindex="-1"><code>sync</code>åŒæ­¥æ¨¡å¼ <a class="header-anchor" href="#syncåŒæ­¥æ¨¡å¼" aria-label="Permalink to &quot;\`sync\`åŒæ­¥æ¨¡å¼&quot;">â€‹</a></h2><ul><li><p><code>performSyncWorkOnRoot</code></p></li><li><p><code>renderRootSync</code></p></li><li><p><code>prepareFreshStack</code></p></li><li><p><code>workLoopSync</code></p></li></ul><h3 id="performsyncworkonroot-æ‰§è¡ŒåŒæ­¥å·¥ä½œ" tabindex="-1"><code>performSyncWorkOnRoot</code> æ‰§è¡ŒåŒæ­¥å·¥ä½œ <a class="header-anchor" href="#performsyncworkonroot-æ‰§è¡ŒåŒæ­¥å·¥ä½œ" aria-label="Permalink to &quot;\`performSyncWorkOnRoot\` æ‰§è¡ŒåŒæ­¥å·¥ä½œ&quot;">â€‹</a></h3><p>åœ¨ <code>sync</code> å¹¶å‘æ¨¡å¼ä¸‹ä¼šæ‰§è¡Œ <code>performSyncWorkOnRoot</code></p><ul><li><code>return null</code>ï¼š <code>flushSyncCallbacks</code> é‡Œçš„ <code>callback</code> æ ¹æ®æ˜¯å¦ä¸º<code>null</code>ï¼Œæ¥<code>ä¸­æ–­å¾ªç¯</code>ï¼ˆ<a href="/rsource/react/lane#reactfibersynctaskqueue"><code>flushSyncCallbacks å¯ä»¥çœ‹è¿™é‡Œ</code></a>ï¼‰</li></ul><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">performSyncWorkOnRoot</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">root</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// è·å¾—æœ€é«˜ä¼˜çš„lane</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">lanes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">getNextLanes</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ¸²æŸ“æ–°çš„fiberæ ‘(ç¬¬ä¸€æ¬¡æ¸²æŸ“æ˜¯ä»¥åŒæ­¥çš„æ–¹å¼æ¸²æŸ“æ ¹èŠ‚ç‚¹ï¼Œåˆæ¬¡æ¸²æŸ“çš„æ—¶å€™ï¼Œéƒ½æ˜¯åŒæ­¥çš„)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">renderRootSync</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">lanes</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// è·å–æ–°æ¸²æŸ“å®Œæˆçš„fiberæ ¹èŠ‚ç‚¹</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">finishedWork</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">alternate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">finishedWork</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">finishedWork</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">commitRoot</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// flushSyncCallbacks é‡Œçš„ callback æ ¹æ®æ˜¯å¦ä¸ºnullï¼Œæ¥ä¸­æ–­å¾ªç¯</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="renderrootsync" tabindex="-1"><code>renderRootSync</code> <a class="header-anchor" href="#renderrootsync" aria-label="Permalink to &quot;\`renderRootSync\`&quot;">â€‹</a></h3><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">renderRootSync</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">root</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">renderLanes</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å¦‚æœæ–°çš„æ ¹å’Œè€çš„æ ¹ä¸ä¸€æ ·ï¼Œæˆ–è€…æ–°çš„æ¸²æŸ“ä¼˜å…ˆçº§å’Œè€çš„æ¸²æŸ“ä¼˜å…ˆçº§ä¸ä¸€æ ·</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">root</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">workInProgressRoot</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">workInProgressRootRenderLanes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">renderLanes</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">prepareFreshStack</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">renderLanes</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">workLoopSync</span><span style="color:#F07178;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">RootCompleted</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="workloopsync" tabindex="-1"><code>workLoopSync</code> <a class="header-anchor" href="#workloopsync" aria-label="Permalink to &quot;\`workLoopSync\`&quot;">â€‹</a></h3><ul><li><p><code>workLoopSync</code>ï¼šå¼€å§‹åŒæ­¥æ¨¡å¼çš„å·¥ä½œå¾ªç¯</p></li><li><p><code>workLoopSync</code> å‡½æ•°ä¼šä¸€ç›´æ‰§è¡Œ <code>performUnitOfWork</code> å‡½æ•°ï¼Œç›´åˆ° <code>workInProgress === null</code>ï¼Œè¡¨ç¤ºæ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„æ¸²æŸ“</p></li></ul><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">workLoopSync</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">workInProgress</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æ‰§è¡Œå·¥ä½œå•å…ƒ</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">performUnitOfWork</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">workInProgress</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="concurrentå¹¶å‘æ¨¡å¼" tabindex="-1"><code>concurrent</code>å¹¶å‘æ¨¡å¼ <a class="header-anchor" href="#concurrentå¹¶å‘æ¨¡å¼" aria-label="Permalink to &quot;\`concurrent\`å¹¶å‘æ¨¡å¼&quot;">â€‹</a></h2><h3 id="performconcurrentworkonrootæ‰§è¡Œå¹¶å‘å·¥ä½œ" tabindex="-1"><code>performConcurrentWorkOnRoot</code>æ‰§è¡Œå¹¶å‘å·¥ä½œ <a class="header-anchor" href="#performconcurrentworkonrootæ‰§è¡Œå¹¶å‘å·¥ä½œ" aria-label="Permalink to &quot;\`performConcurrentWorkOnRoot\`æ‰§è¡Œå¹¶å‘å·¥ä½œ&quot;">â€‹</a></h3><p>åœ¨ <code>concurrent</code> å¹¶å‘æ¨¡å¼ä¸‹ä¼šæ‰§è¡Œ <code>performConcurrentWorkOnRoot</code></p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">performConcurrentWorkOnRoot</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">root</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">didTimeout</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å…ˆè·å–å½“å‰æ ¹èŠ‚ç‚¹ä¸Šçš„ä»»åŠ¡</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">originalCallbackNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">callbackNode</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//è·å–å½“å‰ä¼˜å…ˆçº§æœ€é«˜çš„è½¦é“</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">lanes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">getNextLanes</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">NoLanes</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">lanes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">NoLanes</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//æ˜¯å¦ä¸åŒ…å«é˜»å¡è½¦é“</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">nonIncludesBlockingLane</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">includesBlockingLane</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">lanes</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//æ˜¯å¦ä¸åŒ…å«è¿‡æœŸçš„è½¦é“</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">nonIncludesExpiredLane</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">includesExpiredLane</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">lanes</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//æ—¶é—´ç‰‡æ²¡æœ‰è¿‡æœŸ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">nonTimeout</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">didTimeout</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//ä¸‰ä¸ªå˜é‡éƒ½æ˜¯çœŸï¼Œæ‰èƒ½è¿›è¡Œæ—¶é—´åˆ†ç‰‡ï¼Œä¹Ÿå°±æ˜¯è¿›è¡Œå¹¶å‘æ¸²æŸ“ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ä¸­æ–­æ‰§è¡Œ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">shouldTimeSlice</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">nonIncludesBlockingLane</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">nonIncludesExpiredLane</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">nonTimeout</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">exitStatus</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">shouldTimeSlice</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">renderRootConcurrent</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">lanes</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">renderRootSync</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">lanes</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å¦‚æœä¸æ˜¯æ¸²æŸ“ä¸­çš„è¯ï¼Œé‚£è¯´æ˜è‚¯å®šæ¸²æŸ“å®Œäº†</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">exitStatus</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">RootInProgress</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">finishedWork</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">alternate</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">finishedWork</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">finishedWork</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">commitRoot</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// è¯´æ˜ä»»åŠ¡æ²¡æœ‰å®Œæˆ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">callbackNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">originalCallbackNode</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æŠŠæ­¤å‡½æ•°è¿”å›ï¼Œä¸‹æ¬¡æ¥ç€æ‰§è¡Œ</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">performConcurrentWorkOnRoot</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bind</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">null,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">root</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h3 id="renderrootconcurrent" tabindex="-1"><code>renderRootConcurrent</code> <a class="header-anchor" href="#renderrootconcurrent" aria-label="Permalink to &quot;\`renderRootConcurrent\`&quot;">â€‹</a></h3><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">renderRootConcurrent</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">root</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">lanes</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">workInProgressRoot</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">root</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">workInProgressRootRenderLanes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">lanes</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">prepareFreshStack</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">lanes</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//åœ¨å½“å‰åˆ†é…çš„æ—¶é—´ç‰‡(5ms)å†…æ‰§è¡Œfiberæ ‘çš„æ„å»ºæˆ–è€…è¯´æ¸²æŸ“ï¼Œ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">workLoopConcurrent</span><span style="color:#F07178;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//å¦‚æœ workInProgressä¸ä¸ºnullï¼Œè¯´æ˜fiberæ ‘çš„æ„å»ºè¿˜æ²¡æœ‰å®Œæˆ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">workInProgress</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">RootInProgress</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">//å¦‚æœworkInProgressæ˜¯nulläº†è¯´æ˜æ¸²æŸ“å·¥ä½œå®Œå…¨ç»“æŸäº†</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">workInProgressRootExitStatus</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="workloopconcurrent" tabindex="-1"><code>workLoopConcurrent</code> <a class="header-anchor" href="#workloopconcurrent" aria-label="Permalink to &quot;\`workLoopConcurrent\`&quot;">â€‹</a></h3><p><code>workLoopConcurrent</code> å‡½æ•°åœ¨ <code>workLoopSync</code> çš„åŸºç¡€ä¸Šå¢åŠ äº† <code>shouldYield</code> çš„åˆ¤æ–­</p><p><code>shouldYield</code> å‡½æ•°ä¼šåˆ¤æ–­å½“å‰æ˜¯å¦æœ‰å‰©ä½™æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰å‰©ä½™æ—¶é—´ï¼Œå°±ä¼šè¿”å› <code>true</code> è¡¨ç¤ºéœ€è¦ä¸­æ–­å½“å‰ä»»åŠ¡</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">workLoopConcurrent</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å¦‚æœæœ‰ä¸‹ä¸€ä¸ªè¦æ„å»ºçš„fiberå¹¶ä¸”æ—¶é—´ç‰‡æ²¡æœ‰è¿‡æœŸ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">workInProgress</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">shouldYield</span><span style="color:#F07178;">()) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">performUnitOfWork</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">workInProgress</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="preparefreshstack" tabindex="-1"><code>prepareFreshStack</code> <a class="header-anchor" href="#preparefreshstack" aria-label="Permalink to &quot;\`prepareFreshStack\`&quot;">â€‹</a></h2><ul><li>å› ä¸ºåœ¨æ„å»º<code>fiberæ ‘</code>çš„è¿‡ç¨‹ä¸­ï¼Œ<code>renderRootSync</code>å’Œ<code>renderRootConcurrent</code>ä¼šåå¤è¿›å…¥ï¼Œæ‰€ä»¥åªæœ‰åœ¨ç¬¬ä¸€æ¬¡è¿›æ¥çš„æ—¶å€™ä¼šåˆ›å»ºæ–°çš„<code>fiberæ ‘</code>ï¼Œæˆ–è€…è¯´<code>æ–°fiber</code></li></ul><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// åˆ›å»ºä¸€ä¸ªæ–°æ ˆ</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">prepareFreshStack</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">root</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">renderLanes</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// åˆ›å»ºæ ¹èŠ‚ç‚¹çš„æ–°fiber</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">workInProgress</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createWorkInProgress</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">root</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æŠŠæ–°çš„æ¸²æŸ“ä¼˜å…ˆçº§ èµ‹å€¼ç»™ workInProgressRootRenderLanes</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">workInProgressRootRenderLanes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">renderLanes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å½“å‰æ­£åœ¨è°ƒåº¦çš„è·ŸèŠ‚ç‚¹ å°±æ˜¯ æ ¹èŠ‚ç‚¹ div #root</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">workInProgressRoot</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">root</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">finishQueueingConcurrentUpdates</span><span style="color:#F07178;">() </span><span style="color:#676E95;font-style:italic;">// åœ¨å·¥ä½œå¾ªç¯ä¹‹å‰å®Œæˆæ›´æ–°é˜Ÿåˆ—çš„æ”¶é›†</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><blockquote><p>æ‰“å°ä¸€ä¸‹ <code>workInProgress</code></p></blockquote><p><img src="https://steinsgate.oss-cn-hangzhou.aliyuncs.com/react/createWorkInProgress.jpg" alt="createWorkInProgress"></p><h3 id="createworkinprogress-åŸºäºè€çš„fiberå’Œæ–°çš„å±æ€§-åˆ›å»ºæ–°çš„fiber" tabindex="-1"><code>createWorkInProgress</code> åŸºäºè€çš„<code>fiber</code>å’Œæ–°çš„å±æ€§ï¼Œåˆ›å»ºæ–°çš„<code>fiber</code> <a class="header-anchor" href="#createworkinprogress-åŸºäºè€çš„fiberå’Œæ–°çš„å±æ€§-åˆ›å»ºæ–°çš„fiber" aria-label="Permalink to &quot;\`createWorkInProgress\` åŸºäºè€çš„\`fiber\`å’Œæ–°çš„å±æ€§ï¼Œåˆ›å»ºæ–°çš„\`fiber\`&quot;">â€‹</a></h3><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight has-highlighted-lines"><code><span class="line"><span style="color:#676E95;font-style:italic;">// ReactFiber.js</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">FiberNode</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">tag</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">pendingProps</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">key</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">createFiber</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">tag</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">pendingProps</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">key</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">FiberNode</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">tag</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">pendingProps</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">key</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">}</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line highlighted"><span style="color:#676E95;font-style:italic;"> * åŸºäºè€çš„fiberå’Œæ–°çš„å±æ€§ï¼Œåˆ›å»ºæ–°çš„fiber</span></span>
<span class="line highlighted"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#89DDFF;font-style:italic;">{</span><span style="color:#FFCB6B;font-style:italic;">*</span><span style="color:#89DDFF;font-style:italic;">}</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#BABED8;font-style:italic;">current</span><span style="color:#676E95;font-style:italic;"> è€fiber</span></span>
<span class="line highlighted"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#89DDFF;font-style:italic;">{</span><span style="color:#FFCB6B;font-style:italic;">*</span><span style="color:#89DDFF;font-style:italic;">}</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#BABED8;font-style:italic;">pendingProps</span><span style="color:#676E95;font-style:italic;"> æ–°å±æ€§</span></span>
<span class="line highlighted"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line highlighted"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">createWorkInProgress</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">current</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">pendingProps</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ‹¿åˆ°è€fiberçš„è®ºæ›¿</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">workInprogress</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">alternate</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">workInprogress</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æ²¡æœ‰å°±å»åˆ›å»º</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#BABED8;">workInprogress</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createFiber</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">tag</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">pendingProps</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">key</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">type</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">stateNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">stateNode</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// åŒå‘æŒ‡å‘ï¼Œäº’ä¸ºæ›¿èº«</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">alternate</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">alternate</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æœ‰å°±å¤ç”¨è€fiber</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">pendingProps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">pendingProps</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">type</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æ¸…ç©ºå‰¯ä½œç”¨</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">flags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">NoFlags</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">subtreeFlags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">NoFlags</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">deletions</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">child</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">child</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">memoizedProps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">memoizedProps</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">memoizedState</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">memoizedState</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">updateQueue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">updateQueue</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">sibling</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">sibling</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">index</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">index</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">ref</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">ref</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">flags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">flags</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">lanes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">lanes</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">childLanes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">childLanes</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">workInprogress</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h2 id="performunitofwork-æ‰§è¡Œå·¥ä½œå•å…ƒ" tabindex="-1"><code>performUnitOfWork</code> æ‰§è¡Œå·¥ä½œå•å…ƒ <a class="header-anchor" href="#performunitofwork-æ‰§è¡Œå·¥ä½œå•å…ƒ" aria-label="Permalink to &quot;\`performUnitOfWork\` æ‰§è¡Œå·¥ä½œå•å…ƒ&quot;">â€‹</a></h2><blockquote><p>æºç åœ°å€ <a href="https://github.com/azzlzzxz/react-source-code/blob/3d95c43b8967d4dda1ec9a22f0d9ea4999fee8b8/packages/react-reconciler/src/ReactFiberWorkLoop.js#L2500" target="_blank" rel="noreferrer">performUnitOfWork ï½œ react-reconciler/src/ReactFiberWorkLoop.js</a></p></blockquote><ul><li><p><code>current</code> è¡¨ç¤ºå½“å‰é¡µé¢æ­£åœ¨ä½¿ç”¨çš„ <code>Fiber èŠ‚ç‚¹</code>ï¼Œå³ <code>workInProgress.alternate</code></p></li><li><p><code>workInProgress</code> è¡¨ç¤ºå½“å‰æ­£åœ¨æ„å»ºçš„ <code>Fiber èŠ‚ç‚¹</code></p></li></ul><div class="tip custom-block"><p class="custom-block-title"><code>performUnitOfWork</code> å·¥ä½œæµç¨‹</p><ul><li>è°ƒç”¨ <code>beginWork</code> å‡½æ•°ï¼Œè¿›å…¥ <code>â€œé€’â€</code> é˜¶æ®µ <ul><li>æ ¹æ®ä¼ å…¥çš„ <code>Fiber èŠ‚ç‚¹</code> åˆ›å»º <code>å­ Fiber èŠ‚ç‚¹</code></li></ul></li><li>è°ƒç”¨ <code>completeUnitOfWork</code> å‡½æ•°ï¼Œè¿›å…¥ <code>â€œå½’â€</code> é˜¶æ®µ <ul><li>è°ƒç”¨ <code>completeWork</code> å‡½æ•°å¯¹åˆ›å»ºå¥½çš„ <code>Fiber èŠ‚ç‚¹</code> è¿›è¡Œå¤„ç†</li></ul></li><li>æ›´æ–° <code>workInProgress</code> æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ª <code>Fiber èŠ‚ç‚¹</code></li></ul></div><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight has-highlighted-lines"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> workInProgress </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">...</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">performUnitOfWork</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">unitOfWork</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// è·å–æ–°çš„fiberå¯¹åº”çš„è€fiber</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">current</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">unitOfWork</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">alternate</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å®Œæˆå½“å‰fiberçš„å­fiberé“¾è¡¨æ„å»ºå</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">next</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">beginWork</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">current</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">unitOfWork</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">workInProgressRootRenderLanes</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æŠŠå¾…ç”Ÿæ•ˆå±æ€§å˜æˆå·²ç”Ÿæ•ˆ</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#BABED8;">unitOfWork</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">memoizedProps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">unitOfWork</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">pendingProps</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">next</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å¦‚æœæ²¡æœ‰å­èŠ‚ç‚¹ï¼Œè¡¨ç¤ºå½“å‰fiberå·²ç»å®Œæˆäº†</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">completeUnitOfWork</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">unitOfWork</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å¦‚æœæœ‰å­èŠ‚ç‚¹ï¼Œå°±è®©å­èŠ‚ç‚¹æˆä¸ºä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ</span></span>
<span class="line highlighted"><span style="color:#F07178;">    </span><span style="color:#BABED8;">workInProgress</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">next</span><span style="color:#89DDFF;">;</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">}</span></span>
<span class="line highlighted"><wbr></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><blockquote><p><code>Fiber æ ‘</code>çš„ç»“æ„</p></blockquote><p><img src="https://steinsgate.oss-cn-hangzhou.aliyuncs.com/begin_work.jpg" alt="begin_work"></p><div class="tip custom-block"><p class="custom-block-title"><code>Fiber æ ‘</code> çš„æ„å»º</p><p>æ•´ä¸ª <code>Fiber æ ‘</code> çš„æ„å»ºæ˜¯ä¸€ä¸ªæ·±åº¦ä¼˜å…ˆéå†ï¼Œå…¶ä¸­çš„ä¸¤ä¸ªé‡è¦å˜é‡ <code>workInProgress</code> å’Œ <code>current</code> å³ä¹‹å‰è¯´çš„ <a href="/rsource/react/introduce#fiber-åŒç¼“å­˜">Fiber åŒç¼“å­˜æœºåˆ¶</a></p><ul><li><code>workInProgress</code> å’Œ <code>current</code> éƒ½æ˜¯ä¸€ä¸ªæŒ‡é’ˆ</li><li><code>workInProgress</code> è¡¨ç¤ºå½“å‰æ­£åœ¨æ„å»ºçš„ <code>Fiber èŠ‚ç‚¹</code></li><li><code>current = workInProgress.alternate</code> ï¼ˆå³ <code>fiber.alternate</code>ï¼‰è¡¨ç¤ºå½“å‰é¡µé¢æ­£åœ¨ä½¿ç”¨çš„ <code>Fiber èŠ‚ç‚¹</code><ul><li>åˆæ¬¡æ„å»ºæ—¶é¡µé¢è¿˜æœªæ¸²æŸ“ï¼Œæ­¤æ—¶ <code>current = null</code></li></ul></li></ul><p>åœ¨æ·±åº¦ä¼˜å…ˆéå†ä¸­æ¯ä¸ª <code>Fiber èŠ‚ç‚¹</code> éƒ½ä¼šç»å†ä¸¤ä¸ªé˜¶æ®µ</p><ul><li><code>â€œé€’â€</code>é˜¶æ®µ <code>beginWork</code></li><li><code>â€œå½’â€</code>é˜¶æ®µ <code>completeWork</code></li></ul><p>è¿™ä¸¤ä¸ªé˜¶æ®µå…±åŒå®Œæˆäº†æ¯ä¸€ä¸ª <code>Fiber èŠ‚ç‚¹</code> çš„åˆ›å»º, æ‰€æœ‰ <code>Fiber èŠ‚ç‚¹</code> è¿æ¥èµ·æ¥å°±æ˜¯ä¸€æ£µ <code>Fiber æ ‘</code></p></div><div class="info custom-block"><p class="custom-block-title">ç›¸å…³èµ„æ–™</p><ul><li><a href="https://react.iamkasong.com/process/reconciler.html" target="_blank" rel="noreferrer">render é˜¶æ®µ æµç¨‹</a></li></ul></div>`,56)]))}const b=n(o,[["render",e]]);export{D as __pageData,b as default};
