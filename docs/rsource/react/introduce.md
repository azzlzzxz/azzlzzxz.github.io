# 介绍 Fiber

## 为什么要有`Fiber`？

::: tip 前置知识

- `JavaScript`是单线程的，而浏览器是多进程的（每个进程有可能包含多个线程）

浏览器是多进程的，其中的渲染进程要处理包括 `事件系统`、`定时器/延时器`、`网络请求`、`GUI 渲染线程`（`GUI` 负责页面的布局和绘制） 等各种线程任务，而`JavaScript`的线程是可以操作`DOM`的，这就使得`JavaScript`线程和浏览器的`GUI 渲染线程`存在互斥的问题。

如果 `GUI 渲染线程` 和 `JavaScript` 线程同时工作，会导致页面的渲染难以预测，例如：染线程刚绘制好的一段文字，`JavaScript` 线程可能会将其修改为其他文字，这样页面可能会渲染混乱、样式错乱、甚至导致页面崩溃

- `JavaScript` 线程会阻塞浏览器渲染

当下主流浏览器的刷新频率为 60Hz，即每 16.6ms（1000ms / 60Hz）浏览器就会刷新一次，而在这 16.6ms 内，需要执行`JavaScript` 脚本、渲染线程也会执行，同时在互斥的机制下，如果 `JavaScript` 长时间的占据主线程，就会导致 **渲染层面的更新就不得不长时间地等待，界面长时间不更新，带给用户的体验就是所谓的“卡顿”**。
:::

在 `React 16` 之前，`React` 使用的是基于 `栈递归` 的协调算法，这种算法会在一次渲染过程中递归遍历整个组件树，并且`不会被打断`，这种递归的方式会带来性能上的瓶颈，尤其是在组件树很大时，渲染时间就会变长，导致浏览器出现卡顿。

`Fiber` 是 `React 16` 引入的一种新的协调算法，用于解决 `React` 在复杂 `UI` 渲染时的性能问题。

**<font color="FF9D00">将递归的无法中断的更新重构为异步的可中断更新</font>**

## 什么是 `Fiber`？

- `Fiber` 作为架构

在旧的架构中，`Reconciler（协调器）` 采用递归的方式执行，无法中断，节点数据保存在递归的调用栈中，被称为 `stack reconciler`。

在新的架构中，`Reconciler` 是基于 `Fiber` 实现的，节点数据保存在 `Fiber` 中，被称为 `Fiber reconciler`。

- `Fiber` 作为静态数据结构

每个`Fiber 节点` 对应一个 `React.element`，保存了该组件的类型`（函数组件 / 类组件 / 原生组件）`、对应的`DOM`节点等信息。

- `Fiber` 作为动态工作单元

`Fiber` 保存着节点的动态信息，包括本次更新中改变的状态、节点更新信息、节点更新优先级、副作用标签等。

## `Fiber` 的作用
